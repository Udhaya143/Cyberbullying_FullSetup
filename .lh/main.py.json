{
    "sourceFile": "main.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 19,
            "patches": [
                {
                    "date": 1762599790171,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762600241037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,10 @@\n from fastapi import FastAPI, Request, Form, UploadFile, File, Depends, HTTPException, BackgroundTasks\n-from fastapi.responses import HTMLResponse, JSONResponse\n+from fastapi.responses import HTMLResponse, RedirectResponse, JSONResponse\n from fastapi.staticfiles import StaticFiles\n from fastapi.templating import Jinja2Templates\n-from fastapi.security import HTTPBasic, HTTPBasicCredentials\n+from fastapi.security import HTTPBasicCredentials\n+from starlette.middleware.sessions import SessionMiddleware\n import joblib, os, json, time\n from pathlib import Path\n from datetime import datetime\n from train_transformer import train_transformer_model\n@@ -14,12 +15,10 @@\n app = FastAPI(title=\"Cyberbullying Detection System\")\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n+app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n \n-security = HTTPBasic()\n-\n-\n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n try:\n@@ -30,132 +29,100 @@\n     FALLBACK = None\n \n transformer_pipeline = None\n \n-\n # ---------------------------------------------------\n-# CYBERBULLYING WORD CONTEXT LISTS\n+# USER MANAGEMENT (login, register, logout)\n # ---------------------------------------------------\n-SEXUAL_CONTEXT = {\n-    \"sexy\", \"hot\", \"naughty\", \"babe\", \"send pic\", \"kiss\", \"boobs\", \"nude\",\n-    \"handsome\", \"beautiful\", \"pretty\", \"cute girl\", \"bed\", \"flirt\", \"babe\",\n-    \"date me\", \"love u\", \"strip\", \"naughty girl\", \"body\", \"lust\", \"porn\"\n-}\n+USER_FILE = BASE_DIR / \"users.json\"\n+if not USER_FILE.exists():\n+    USER_FILE.write_text(json.dumps({\"admin\": {\"password\": \"password\"}}))\n \n-VIOLENCE_CONTEXT = {\n-    \"kill\", \"bomb\", \"murder\", \"attack\", \"shoot\", \"gun\", \"destroy\", \"stab\",\n-    \"die\", \"death\", \"blood\", \"terror\", \"explode\", \"threat\"\n-}\n \n-HATE_CONTEXT = {\n-    \"hate\", \"idiot\", \"stupid\", \"dumb\", \"moron\", \"worthless\", \"fat\", \"ugly\",\n-    \"trash\", \"loser\", \"jerk\", \"freak\", \"bitch\", \"bastard\", \"slut\", \"pig\"\n-}\n+def get_users():\n+    try:\n+        return json.loads(USER_FILE.read_text())\n+    except Exception:\n+        return {}\n \n-RELIGIOUS_CONTEXT = {\n-    \"islam\", \"christian\", \"hindu\", \"jew\", \"allah\", \"jesus\", \"temple\", \"church\",\n-    \"religion\", \"quran\", \"bible\", \"prophet\", \"god\", \"priest\", \"muslim\", \"satan\"\n-}\n \n-MENTAL_HEALTH_CONTEXT = {\n-    \"suicide\", \"depress\", \"kill yourself\", \"go die\", \"hopeless\", \"worthless\",\n-    \"sad\", \"hurt\", \"anxiety\", \"alone\", \"mental\", \"die now\"\n-}\n+def save_users(users):\n+    USER_FILE.write_text(json.dumps(users, indent=2))\n \n+\n+def get_current_user(request: Request):\n+    user = request.session.get(\"user\")\n+    if not user:\n+        raise HTTPException(status_code=401, detail=\"Unauthorized\")\n+    return user\n+\n+\n # ---------------------------------------------------\n-# UTILITY FUNCTIONS\n+# BASIC WORD LISTS\n # ---------------------------------------------------\n+SEXUAL_CONTEXT = {\"sexy\", \"hot\", \"naughty\", \"babe\", \"kiss\", \"boobs\", \"nude\", \"bed\", \"flirt\", \"lust\", \"porn\"}\n+VIOLENCE_CONTEXT = {\"kill\", \"bomb\", \"attack\", \"shoot\", \"gun\", \"die\", \"murder\"}\n+HATE_CONTEXT = {\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n+MENTAL_HEALTH_CONTEXT = {\"suicide\", \"depress\", \"kill yourself\", \"hopeless\", \"worthless\", \"sad\", \"hurt\"}\n+\n+# ---------------------------------------------------\n+# HELPERS\n+# ---------------------------------------------------\n def datetimeformat(value):\n     try:\n         return datetime.fromtimestamp(value).strftime(\"%Y-%m-%d %H:%M:%S\")\n     except Exception:\n         return \"N/A\"\n \n+\n templates.env.filters[\"datetimeformat\"] = datetimeformat\n \n \n # ---------------------------------------------------\n-# AUTHENTICATION\n+# DETECTION LOGIC\n # ---------------------------------------------------\n-def get_current_username(credentials: HTTPBasicCredentials = Depends(security)):\n-    correct_username = os.environ.get(\"DEMO_USER\", \"admin\")\n-    correct_password = os.environ.get(\"DEMO_PASS\", \"password\")\n-    if credentials.username == correct_username and credentials.password == correct_password:\n-        return credentials.username\n-    raise HTTPException(status_code=401, detail=\"Unauthorized\")\n-\n-\n-# ---------------------------------------------------\n-# MAIN DETECTION FUNCTION\n-# ---------------------------------------------------\n def predict_text(text: str, use_transformer: bool = False):\n-    \"\"\"Detect cyberbullying content using rules + transformer + fallback model.\"\"\"\n     global transformer_pipeline\n+    text_low = text.lower()\n     model_used = \"Fallback TF-IDF\"\n-    lower_text = text.lower().strip()\n \n-    def match_any(phrases):\n-        return any(phrase in lower_text for phrase in phrases)\n+    def match_any(words):\n+        return any(w in text_low for w in words)\n \n-    # --- Enhanced Rule-based Filters ---\n     if match_any(SEXUAL_CONTEXT):\n-        return \"Cyberbullying\", 0.99, \"Sexual/Harassment Content\"\n+        return \"Cyberbullying\", 0.99, \"Sexual Harassment\"\n     if match_any(VIOLENCE_CONTEXT):\n-        return \"Cyberbullying\", 0.98, \"Violent/Threatening Language\"\n+        return \"Cyberbullying\", 0.97, \"Violence/Threat\"\n     if match_any(HATE_CONTEXT):\n-        return \"Cyberbullying\", 0.97, \"Hate/Insult Language\"\n-    if match_any(RELIGIOUS_CONTEXT):\n-        return \"Cyberbullying\", 0.96, \"Religious Disrespect\"\n+        return \"Cyberbullying\", 0.96, \"Insult/Hate\"\n     if match_any(MENTAL_HEALTH_CONTEXT):\n-        return \"Cyberbullying\", 0.95, \"Mental Health Abuse\"\n+        return \"Cyberbullying\", 0.94, \"Mental Health Abuse\"\n \n-    # Context-based short phrases\n-    if any(word in lower_text for word in [\"send pic\", \"naughty\", \"flirt\", \"babe\", \"hot girl\", \"hi sexy\", \"cute body\"]):\n-        return \"Cyberbullying\", 0.97, \"Flirty/Harassment Message\"\n-    if any(word in lower_text for word in [\"go die\", \"hate you\", \"you are ugly\", \"fool\", \"idiot\", \"fat\", \"loser\"]):\n-        return \"Cyberbullying\", 0.96, \"Insult/Abuse Message\"\n-\n-    # --- Transformer model ---\n+    # Transformer\n     if use_transformer:\n-        model_name = os.environ.get(\"HF_MODEL\", \"unitary/toxic-bert\")\n         try:\n             from transformers import pipeline\n             if transformer_pipeline is None:\n-                print(f\"üîÑ Loading transformer model: {model_name}\")\n-                transformer_pipeline = pipeline(\"text-classification\", model=model_name, device=-1)\n-\n+                transformer_pipeline = pipeline(\"text-classification\", model=\"unitary/toxic-bert\", device=-1)\n             pred = transformer_pipeline(text, truncation=True)[0]\n-            label_raw = pred.get(\"label\", \"\").lower()\n-            score = float(pred.get(\"score\", 0.0))\n-            toxic_keywords = [\"toxic\", \"abuse\", \"offensive\", \"hate\", \"insult\"]\n-\n-            if any(k in label_raw for k in toxic_keywords) or \"label_1\" in label_raw:\n-                label = \"Cyberbullying\" if score >= 0.45 else \"Non-Cyberbullying\"\n-            else:\n-                label = \"Cyberbullying\" if score >= 0.75 and label_raw.startswith(\"negative\") else \"Non-Cyberbullying\"\n-\n-            return label, score, f\"Transformer ({model_name})\"\n+            label = \"Cyberbullying\" if \"toxic\" in pred[\"label\"].lower() else \"Non-Cyberbullying\"\n+            return label, pred[\"score\"], \"Transformer\"\n         except Exception as e:\n-            print(f\"‚ö†Ô∏è Transformer Error: {e}\")\n-            return \"Error\", 0.0, f\"Transformer ({model_name})\"\n+            print(\"Transformer error:\", e)\n \n-    # --- Fallback Model (TF-IDF) ---\n-    if FALLBACK is not None:\n-        try:\n-            pred = FALLBACK.predict([text])[0]\n-            prob = float(FALLBACK.predict_proba([text])[0][1]) if hasattr(FALLBACK, \"predict_proba\") else 0.5\n-            label = \"Cyberbullying\" if pred == 1 else \"Non-Cyberbullying\"\n-            return label, prob, model_used\n-        except Exception as e:\n-            print(f\"‚ö†Ô∏è Fallback model error: {e}\")\n-            return \"Error\", 0.0, \"Fallback Error\"\n+    if FALLBACK is None:\n+        return \"Error\", 0.0, \"No model\"\n \n-    return \"Error\", 0.0, \"No model available\"\n+    try:\n+        pred = FALLBACK.predict([text])[0]\n+        prob = float(FALLBACK.predict_proba([text])[0][1])\n+        label = \"Cyberbullying\" if pred == 1 else \"Non-Cyberbullying\"\n+        return label, prob, model_used\n+    except Exception as e:\n+        print(f\"Fallback error: {e}\")\n+        return \"Error\", 0.0, \"Fallback Error\"\n \n \n-# ---------------------------------------------------\n-# LOGGING\n-# ---------------------------------------------------\n def log_prediction_data(text, label):\n     log_path = BASE_DIR / \"predictions_log.json\"\n     entry = {\"text\": text, \"label\": label, \"timestamp\": time.time()}\n     data = []\n@@ -187,48 +154,57 @@\n     )\n \n \n @app.get(\"/dashboard\", response_class=HTMLResponse)\n-async def dashboard(request: Request, username: str = Depends(get_current_username)):\n-    \"\"\"Admin dashboard view\"\"\"\n+async def dashboard(request: Request):\n+    user = request.session.get(\"user\")\n+    if not user:\n+        return RedirectResponse(\"/login\")\n+\n     log_path = BASE_DIR / \"predictions_log.json\"\n     stats = {\"total\": 0, \"bullying\": 0, \"non\": 0, \"recent\": []}\n     if log_path.exists():\n         data = json.loads(log_path.read_text())\n         stats[\"total\"] = len(data)\n         stats[\"recent\"] = data[-10:][::-1]\n         stats[\"bullying\"] = sum(1 for d in data if d[\"label\"] == \"Cyberbullying\")\n         stats[\"non\"] = stats[\"total\"] - stats[\"bullying\"]\n-    return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": username})\n \n+    return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": user})\n \n-@app.get(\"/train_transformer\", response_class=HTMLResponse)\n-async def train_transformer_page(request: Request, username: str = Depends(get_current_username)):\n-    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"user\": username})\n \n+# ---------------------------------------------------\n+# AUTH ROUTES (LOGIN / LOGOUT / REGISTER)\n+# ---------------------------------------------------\n+@app.get(\"/login\", response_class=HTMLResponse)\n+async def login_page(request: Request):\n+    return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"\"})\n \n-@app.post(\"/train_transformer\", response_class=HTMLResponse)\n-async def train_transformer_post(\n-    request: Request,\n-    file: UploadFile = File(...),\n-    background_tasks: BackgroundTasks = None,\n-    username: str = Depends(get_current_username)\n-):\n-    \"\"\"Train transformer using uploaded CSV\"\"\"\n-    content = await file.read()\n-    models_dir = BASE_DIR / \"models\"\n-    models_dir.mkdir(exist_ok=True)\n-    csv_path = models_dir / f\"uploaded_{int(time.time())}.csv\"\n-    csv_path.write_bytes(content)\n \n-    def run_training():\n-        try:\n-            model_path = train_transformer_model(str(csv_path))\n-            with open(BASE_DIR / \"train_status.log\", \"w\", encoding=\"utf-8\") as f:\n-                f.write(f\"‚úÖ Model trained successfully at {model_path}\\n\")\n-        except Exception as e:\n-            with open(BASE_DIR / \"train_status.log\", \"w\", encoding=\"utf-8\") as f:\n-                f.write(f\"‚ùå Training failed: {e}\\n\")\n+@app.post(\"/login\", response_class=HTMLResponse)\n+async def login_user(request: Request, username: str = Form(...), password: str = Form(...)):\n+    users = get_users()\n+    if username in users and users[username][\"password\"] == password:\n+        request.session[\"user\"] = username\n+        return RedirectResponse(\"/dashboard\", status_code=303)\n+    return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚ùå Invalid credentials\"})\n \n-    background_tasks.add_task(run_training)\n-    message = \"üöÄ Training started in background. Please wait and refresh.\"\n-    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": message, \"user\": username})\n+\n+@app.get(\"/register\", response_class=HTMLResponse)\n+async def register_page(request: Request):\n+    return templates.TemplateResponse(\"register.html\", {\"request\": request, \"message\": \"\"})\n+\n+\n+@app.post(\"/register\", response_class=HTMLResponse)\n+async def register_user(request: Request, username: str = Form(...), password: str = Form(...)):\n+    users = get_users()\n+    if username in users:\n+        return templates.TemplateResponse(\"register.html\", {\"request\": request, \"message\": \"‚ö†Ô∏è Username already exists\"})\n+    users[username] = {\"password\": password}\n+    save_users(users)\n+    return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚úÖ Registered successfully! Please log in.\"})\n+\n+\n+@app.get(\"/logout\")\n+async def logout(request: Request):\n+    request.session.clear()\n+    return RedirectResponse(\"/\", status_code=303)\n"
                },
                {
                    "date": 1762600706629,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,9 +60,9 @@\n # BASIC WORD LISTS\n # ---------------------------------------------------\n SEXUAL_CONTEXT = {\"sexy\", \"hot\", \"naughty\", \"babe\", \"kiss\", \"boobs\", \"nude\", \"bed\", \"flirt\", \"lust\", \"porn\"}\n VIOLENCE_CONTEXT = {\"kill\", \"bomb\", \"attack\", \"shoot\", \"gun\", \"die\", \"murder\"}\n-HATE_CONTEXT = {\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n+HATE_CONTEXT = {\"harm\",\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n MENTAL_HEALTH_CONTEXT = {\"suicide\", \"depress\", \"kill yourself\", \"hopeless\", \"worthless\", \"sad\", \"hurt\"}\n \n # ---------------------------------------------------\n # HELPERS\n"
                },
                {
                    "date": 1762600769953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,9 +60,9 @@\n # BASIC WORD LISTS\n # ---------------------------------------------------\n SEXUAL_CONTEXT = {\"sexy\", \"hot\", \"naughty\", \"babe\", \"kiss\", \"boobs\", \"nude\", \"bed\", \"flirt\", \"lust\", \"porn\"}\n VIOLENCE_CONTEXT = {\"kill\", \"bomb\", \"attack\", \"shoot\", \"gun\", \"die\", \"murder\"}\n-HATE_CONTEXT = {\"harm\",\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n+HATE_CONTEXT = {\"useless\",\"harm\",\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n MENTAL_HEALTH_CONTEXT = {\"suicide\", \"depress\", \"kill yourself\", \"hopeless\", \"worthless\", \"sad\", \"hurt\"}\n \n # ---------------------------------------------------\n # HELPERS\n"
                },
                {
                    "date": 1762601063521,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,13 +58,149 @@\n \n # ---------------------------------------------------\n # BASIC WORD LISTS\n # ---------------------------------------------------\n-SEXUAL_CONTEXT = {\"sexy\", \"hot\", \"naughty\", \"babe\", \"kiss\", \"boobs\", \"nude\", \"bed\", \"flirt\", \"lust\", \"porn\"}\n-VIOLENCE_CONTEXT = {\"kill\", \"bomb\", \"attack\", \"shoot\", \"gun\", \"die\", \"murder\"}\n-HATE_CONTEXT = {\"useless\",\"harm\",\"idiot\", \"stupid\", \"moron\", \"worthless\", \"fat\", \"ugly\", \"bitch\", \"slut\", \"trash\", \"loser\"}\n-MENTAL_HEALTH_CONTEXT = {\"suicide\", \"depress\", \"kill yourself\", \"hopeless\", \"worthless\", \"sad\", \"hurt\"}\n+SEXUAL_CONTEXT = {\n+    \"sex\", \"sexual\", \"nude\", \"naked\", \"boobs\", \"breast\", \"tits\", \"bra\", \"panty\", \"underwear\", \n+    \"kiss\", \"kissing\", \"hot\", \"sexy\", \"horny\", \"babe\", \"lust\", \"adult\", \"erotic\", \"fetish\", \n+    \"porn\", \"porno\", \"pornography\", \"camgirl\", \"camguy\", \"strip\", \"stripper\", \"striptease\", \n+    \"seduce\", \"seducing\", \"seduction\", \"aroused\", \"arousal\", \"orgasm\", \"masturbate\", \n+    \"masturbation\", \"cock\", \"dick\", \"penis\", \"pussy\", \"vagina\", \"clit\", \"clitoris\", \"cum\", \n+    \"sperm\", \"ejaculate\", \"ejaculation\", \"wet\", \"naughty\", \"bedroom\", \"foreplay\", \"lingerie\", \n+    \"modeling\", \"handsome\", \"beautiful\", \"gorgeous\", \"pretty\", \"body\", \"curves\", \"butt\", \n+    \"booty\", \"ass\", \"thighs\", \"legs\", \"figure\", \"bikini\", \"thong\", \"dating\", \"love\", \"flirt\", \n+    \"flirting\", \"romantic\", \"kinky\", \"fetish\", \"xxx\", \"69\", \"blowjob\", \"handjob\", \"deepthroat\", \n+    \"anal\", \"doggy\", \"missionary\", \"threesome\", \"naughty\", \"hookup\", \"one-night\", \"crush\", \n+    \"makeout\", \"smexy\", \"hottie\", \"nips\", \"nipple\", \"nipslip\", \"lick\", \"licking\", \"touch\", \n+    \"caress\", \"moan\", \"moaning\", \"lustful\", \"intimate\", \"intimacy\", \"naughtiness\", \n+    \"provocative\", \"tempting\", \"temptation\", \"entice\", \"spank\", \"dominatrix\", \"submissive\", \n+    \"roleplay\", \"dirty\", \"explicit\", \"vulgar\", \"sensual\", \"romance\", \"playboy\", \"playgirl\", \n+    \"onlyfans\", \"hooker\", \"escort\", \"prostitute\", \"prostitution\", \"brothel\", \"lusting\", \n+    \"twerk\", \"twerking\", \"bodycam\", \"cam\", \"suck\", \"sucking\", \"licking\", \"thirsty\"\n+}\n+VIOLENCE_CONTEXT = {\n+    # --- Physical Violence & Threats ---\n+    \"kill\", \"murder\", \"shoot\", \"stab\", \"bomb\", \"attack\", \"beat\", \"beating\", \"fight\", \n+    \"fighting\", \"hurt\", \"harm\", \"cut\", \"knife\", \"blood\", \"bleed\", \"die\", \"death\", \n+    \"dead\", \"explode\", \"explosion\", \"firebomb\", \"massacre\", \"slaughter\", \"terror\", \n+    \"terrorist\", \"terrorism\", \"suicide\", \"suicidal\", \"execute\", \"execution\", \"hang\", \n+    \"hanging\", \"poison\", \"choke\", \"strangle\", \"shooting\", \"blowup\", \"torture\", \n+    \"assault\", \"crush\", \"destroy\", \"hitman\", \"gun\", \"rifle\", \"pistol\", \"weapon\", \n+    \"grenade\", \"bullet\", \"mine\", \"blast\", \"riot\", \"war\", \"warfare\", \"killself\", \n+    \"jump\", \"bridge\", \"bloodshed\", \"knifeattack\", \"bombblast\", \"massshooting\", \n+    \"explode\", \"abuse\", \"burn\", \"burning\", \"kidnap\", \"rape\", \"rapist\", \"hangman\",\n \n+    # --- Aggression & Intimidation ---\n+    \"threat\", \"threaten\", \"kill you\", \"beat you\", \"shoot you\", \"stab you\", \n+    \"crush you\", \"destroy you\", \"hurt you\", \"bomb you\", \"die soon\", \"go die\", \n+    \"choke you\", \"slap you\", \"kick you\", \"shootdown\", \"wipeout\", \"obliterate\", \n+    \"cutthroat\", \"hostage\", \"murderer\", \"killer\", \"arson\", \"gang\", \"mafia\", \n+    \"cartel\", \"assassin\", \"suicidebomber\", \"terrorattack\", \"executehim\", \n+    \"executeher\", \"beatup\", \"knockout\", \"take revenge\", \"revenge\", \"revengeful\",\n+\n+    # --- Hate / Genocidal / Extremist ---\n+    \"nazi\", \"hitler\", \"gaschamber\", \"lynch\", \"lynching\", \"massmurder\", \n+    \"die soon\", \"genocide\", \"holocaust\", \"shootall\", \"slay\", \"slaying\", \n+    \"attackers\", \"terrorcell\", \"jihad\", \"isis\", \"alqaeda\", \"extremist\", \n+    \"terrorgroup\", \"militia\", \"warcriminal\", \"brutal\", \"brutality\", \n+    \"shootout\", \"hijack\", \"hostage\", \"suicideattack\", \"bloodbath\", \n+    \"vengeance\", \"executioner\", \"slaughterhouse\", \"battlefield\", \"murderous\"\n+}\n+HATE_CONTEXT = {\n+    # --- General Hate Speech ---\n+    \"hate\", \"hateful\", \"disgusting\", \"disgrace\", \"scum\", \"trash\", \"vermin\", \"filth\", \n+    \"worthless\", \"dirty\", \"rotten\", \"evil\", \"ugly\", \"stupid\", \"idiot\", \"freak\", \"loser\",\n+    \"disgust\", \"vile\", \"toxic\", \"pig\", \"dog\", \"animal\", \"filthy\", \"garbage\", \"dumb\",\n+    \"moron\", \"monster\", \"trashbag\", \"sick\", \"degenerate\", \"disgusted\", \"nasty\", \"witch\",\n+    \"whore\", \"slut\", \"bastard\", \"cunt\", \"jerk\", \"retard\", \"psychopath\", \"coward\", \"clown\",\n+\n+    # --- Race & Ethnicity (Global Slurs & Hate) ---\n+    \"racist\", \"racism\", \"nigger\", \"negro\", \"chink\", \"gook\", \"beaner\", \"cracker\",\n+    \"redneck\", \"wetback\", \"spic\", \"coon\", \"gypsy\", \"ape\", \"monkey\", \"tribal\", \n+    \"savage\", \"uncivilized\", \"subhuman\", \"slave\", \"jungleman\", \"go back to africa\",\n+    \"immigrant trash\", \"white trash\", \"brownie\", \"halfbreed\", \"yellowman\", \"arab terrorist\",\n+    \"terrorist\", \"sandnigger\", \"foreign scum\", \"blackie\", \"indiot\", \"hindu freak\",\n+\n+    # --- Religion & Belief ---\n+    \"muslimterrorist\", \"muslimdog\", \"jewtrash\", \"antisemite\", \"kike\", \"christfreak\",\n+    \"jesusfreak\", \"allahlover\", \"pagan\", \"infidel\", \"devilworshipper\", \"heathen\",\n+    \"islamophobic\", \"islamophobia\", \"christophobia\", \"zionistpig\", \"holytrash\",\n+    \"churchburner\", \"quranburner\", \"templetrash\", \"buddhafreak\", \"atheistdog\",\n+\n+    # --- Gender & LGBTQ+ Hate ---\n+    \"gay\", \"faggot\", \"lesbo\", \"dyke\", \"tranny\", \"transfreak\", \"queer\", \"homo\", \"gaytrash\",\n+    \"gendertrash\", \"crossdresser\", \"she-male\", \"ladyboy\", \"sissy\", \"feminazi\", \"misogynist\",\n+    \"bitch\", \"whore\", \"slut\", \"hoe\", \"gold-digger\", \"skank\", \"femalescum\", \"manhater\",\n+    \"toxicman\", \"gaylover\", \"rainbowtrash\", \"shemale\", \"queerfreak\", \"transhate\",\n+\n+    # --- Nationality / Region Hate ---\n+    \"paki\", \"chinesevirus\", \"indiantrash\", \"filipinotrash\", \"mexicantrash\", \"japtrash\",\n+    \"arabtrash\", \"blacktrash\", \"whitepig\", \"americandog\", \"chinklover\", \"asianpig\",\n+    \"europeanscum\", \"africantrash\", \"indiandog\", \"russianpig\", \"ukrainiantrash\",\n+    \"italianmafia\", \"irishdrunk\", \"africanmonkey\", \"browntrash\", \"latinopig\",\n+\n+    # --- Political / Ideological Hate ---\n+    \"nazi\", \"fascist\", \"commie\", \"communistpig\", \"lefttrash\", \"righttrash\", \"wokefreak\",\n+    \"snowflake\", \"libtard\", \"reptilian\", \"marxist\", \"extremist\", \"terrorlover\", \n+    \"redtrash\", \"bluepig\", \"demofreak\", \"repubfreak\", \"dictatorlover\",\n+\n+    # --- Targeted Violence & Hate Intent ---\n+    \"burnthem\", \"killthem\", \"destroythem\", \"shootthem\", \"wipeout\", \"exterminate\", \n+    \"hangthem\", \"dieall\", \"bombthem\", \"nuke\", \"eradicate\", \"masskill\", \"go back\",\n+    \"send them home\", \"get out\", \"not welcome\", \"you people\", \"your kind\", \"they all stink\",\n+    \"hate group\", \"whitepower\", \"blmtrash\", \"kkk\", \"neo-nazi\", \"skinhead\", \"supremacist\",\n+    \"gaschamber\", \"lynch\", \"execute\", \"no lives matter\", \"hatecrime\"\n+}\n+MENTAL_HEALTH_CONTEXT = {\n+    # --- Depression & Sadness ---\n+    \"depressed\", \"sad\", \"hopeless\", \"worthless\", \"numb\", \"lonely\", \"miserable\", \"exhausted\",\n+    \"tiredoflife\", \"crying\", \"pain\", \"hurt\", \"useless\", \"empty\", \"lost\", \"dark\", \"lifeless\",\n+    \"can‚Äôt go on\", \"pointless\", \"suffering\", \"no one cares\", \"hate myself\", \"broken\", \"meaningless\",\n+    \"failed\", \"failure\", \"donewithlife\", \"lowenergy\", \"mentalpain\", \"despair\",\n+\n+    # --- Anxiety & Panic ---\n+    \"anxiety\", \"panic\", \"scared\", \"fear\", \"overthinking\", \"nervous\", \"shaking\", \"paranoid\",\n+    \"can‚Äôt breathe\", \"panicattack\", \"heart racing\", \"stress\", \"worry\", \"suffocating\",\n+    \"fearful\", \"terrified\", \"no control\", \"helpless\", \"triggered\", \"anxious\", \"nervousbreakdown\",\n+\n+    # --- Self-Harm & Suicide ---\n+    \"suicide\", \"kill myself\", \"end my life\", \"want to die\", \"cut myself\", \"selfharm\",\n+    \"slit my wrist\", \"i‚Äôm done\", \"die\", \"jump off\", \"no reason to live\", \"goodbye forever\",\n+    \"it‚Äôs over\", \"drinking bleach\", \"take pills\", \"not waking up\", \"hang myself\",\n+    \"bleed out\", \"can‚Äôt handle\", \"done living\", \"kill me\", \"suffocate\", \"overdose\",\n+    \"i‚Äôm tired of living\", \"i want to disappear\", \"self destruction\", \"goodbye world\",\n+\n+    # --- Bullying-Related Mental Pressure ---\n+    \"bullied\", \"they mock me\", \"i‚Äôm nothing\", \"they hate me\", \"everyone laughs\", \n+    \"embarrassed\", \"humiliated\", \"excluded\", \"unwanted\", \"rejected\", \"ignored\",\n+    \"no friends\", \"outcast\", \"they call me names\", \"i hate school\", \"hate everyone\",\n+    \"they make fun of me\", \"i‚Äôm ugly\", \"i‚Äôm stupid\", \"no one loves me\", \"can‚Äôt fit in\",\n+\n+    # --- Trauma / PTSD / Abuse ---\n+    \"trauma\", \"abuse\", \"molested\", \"raped\", \"beaten\", \"hurt inside\", \"broken soul\",\n+    \"can‚Äôt sleep\", \"nightmares\", \"flashbacks\", \"traumatized\", \"crisis\", \"abandoned\",\n+    \"controlled\", \"gaslight\", \"manipulated\", \"trapped\", \"fear of people\", \"haunted\",\n+    \"can‚Äôt trust anyone\", \"no escape\", \"mentalbreak\", \"suffering inside\",\n+\n+    # --- Mental Illness / Conditions ---\n+    \"adhd\", \"bipolar\", \"schizophrenia\", \"psychosis\", \"ocd\", \"addiction\", \"autistic\",\n+    \"borderline\", \"personalitydisorder\", \"eatingdisorder\", \"anorexia\", \"bulimia\",\n+    \"alcoholic\", \"drugaddict\", \"mentallyill\", \"crazy\", \"insane\", \"psycho\", \"mad\", \"delusional\",\n+\n+    # --- Encouraging Self-Harm / Negativity ---\n+    \"you should die\", \"nobody cares\", \"kill yourself\", \"drink bleach\", \"you‚Äôre worthless\",\n+    \"no one loves you\", \"cut deeper\", \"just die\", \"go kill yourself\", \"hang yourself\",\n+    \"nobody would miss you\", \"do it already\", \"you‚Äôre a failure\", \"you‚Äôre disgusting\",\n+    \"why are you alive\", \"you‚Äôre a loser\", \"you deserve to die\", \"nobody likes you\",\n+    \"you should disappear\", \"your life is a joke\", \"kill yourself now\",\n+\n+    # --- Counseling / Help Phrases (Detection of Suicidal Intent) ---\n+    \"need help\", \"talk to someone\", \"therapy\", \"mental health\", \"counseling\",\n+    \"helpline\", \"i want to talk\", \"need support\", \"i feel weak\", \"can‚Äôt do this\",\n+    \"i want to see a therapist\", \"help me\", \"i‚Äôm scared\", \"save me\", \"please listen\",\n+    \"nobody understands\", \"crisis hotline\", \"need someone to talk to\"\n+}\n+\n # ---------------------------------------------------\n # HELPERS\n # ---------------------------------------------------\n def datetimeformat(value):\n"
                },
                {
                    "date": 1762601864934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n+# main.py\n from fastapi import FastAPI, Request, Form, UploadFile, File, Depends, HTTPException, BackgroundTasks\n from fastapi.responses import HTMLResponse, RedirectResponse, JSONResponse\n from fastapi.staticfiles import StaticFiles\n from fastapi.templating import Jinja2Templates\n-from fastapi.security import HTTPBasicCredentials\n from starlette.middleware.sessions import SessionMiddleware\n import joblib, os, json, time\n from pathlib import Path\n from datetime import datetime\n@@ -15,28 +15,30 @@\n app = FastAPI(title=\"Cyberbullying Detection System\")\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n-app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n+app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")  # keep a strong key in prod\n \n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n+FALLBACK = None\n try:\n     FALLBACK = joblib.load(BASE_DIR / \"model.pkl\")\n     print(\"‚úÖ Loaded fallback model (model.pkl).\")\n except Exception as e:\n     print(f\"‚ö†Ô∏è Fallback model not found: {e}\")\n-    FALLBACK = None\n \n+# transformer (lazy)\n transformer_pipeline = None\n+LOCAL_TRANSFORMER_DIR = BASE_DIR / \"models\" / \"transformer_model\"  # where training saves\n \n # ---------------------------------------------------\n # USER MANAGEMENT (login, register, logout)\n # ---------------------------------------------------\n USER_FILE = BASE_DIR / \"users.json\"\n if not USER_FILE.exists():\n-    USER_FILE.write_text(json.dumps({\"admin\": {\"password\": \"password\"}}))\n+    USER_FILE.write_text(json.dumps({\"admin\": {\"password\": \"password\"}}, indent=2))\n \n \n def get_users():\n     try:\n@@ -54,147 +56,113 @@\n     if not user:\n         raise HTTPException(status_code=401, detail=\"Unauthorized\")\n     return user\n \n-\n # ---------------------------------------------------\n-# BASIC WORD LISTS\n+# CONTEXT WORD LISTS (as provided)\n # ---------------------------------------------------\n SEXUAL_CONTEXT = {\n-    \"sex\", \"sexual\", \"nude\", \"naked\", \"boobs\", \"breast\", \"tits\", \"bra\", \"panty\", \"underwear\", \n-    \"kiss\", \"kissing\", \"hot\", \"sexy\", \"horny\", \"babe\", \"lust\", \"adult\", \"erotic\", \"fetish\", \n-    \"porn\", \"porno\", \"pornography\", \"camgirl\", \"camguy\", \"strip\", \"stripper\", \"striptease\", \n-    \"seduce\", \"seducing\", \"seduction\", \"aroused\", \"arousal\", \"orgasm\", \"masturbate\", \n-    \"masturbation\", \"cock\", \"dick\", \"penis\", \"pussy\", \"vagina\", \"clit\", \"clitoris\", \"cum\", \n-    \"sperm\", \"ejaculate\", \"ejaculation\", \"wet\", \"naughty\", \"bedroom\", \"foreplay\", \"lingerie\", \n-    \"modeling\", \"handsome\", \"beautiful\", \"gorgeous\", \"pretty\", \"body\", \"curves\", \"butt\", \n-    \"booty\", \"ass\", \"thighs\", \"legs\", \"figure\", \"bikini\", \"thong\", \"dating\", \"love\", \"flirt\", \n-    \"flirting\", \"romantic\", \"kinky\", \"fetish\", \"xxx\", \"69\", \"blowjob\", \"handjob\", \"deepthroat\", \n-    \"anal\", \"doggy\", \"missionary\", \"threesome\", \"naughty\", \"hookup\", \"one-night\", \"crush\", \n-    \"makeout\", \"smexy\", \"hottie\", \"nips\", \"nipple\", \"nipslip\", \"lick\", \"licking\", \"touch\", \n-    \"caress\", \"moan\", \"moaning\", \"lustful\", \"intimate\", \"intimacy\", \"naughtiness\", \n-    \"provocative\", \"tempting\", \"temptation\", \"entice\", \"spank\", \"dominatrix\", \"submissive\", \n-    \"roleplay\", \"dirty\", \"explicit\", \"vulgar\", \"sensual\", \"romance\", \"playboy\", \"playgirl\", \n-    \"onlyfans\", \"hooker\", \"escort\", \"prostitute\", \"prostitution\", \"brothel\", \"lusting\", \n+    \"sex\", \"sexual\", \"nude\", \"naked\", \"boobs\", \"breast\", \"tits\", \"bra\", \"panty\", \"underwear\",\n+    \"kiss\", \"kissing\", \"hot\", \"sexy\", \"horny\", \"babe\", \"lust\", \"adult\", \"erotic\", \"fetish\",\n+    \"porn\", \"porno\", \"pornography\", \"camgirl\", \"camguy\", \"strip\", \"stripper\", \"striptease\",\n+    \"seduce\", \"seducing\", \"seduction\", \"aroused\", \"arousal\", \"orgasm\", \"masturbate\",\n+    \"masturbation\", \"cock\", \"dick\", \"penis\", \"pussy\", \"vagina\", \"clit\", \"clitoris\", \"cum\",\n+    \"sperm\", \"ejaculate\", \"ejaculation\", \"wet\", \"naughty\", \"bedroom\", \"foreplay\", \"lingerie\",\n+    \"modeling\", \"handsome\", \"beautiful\", \"gorgeous\", \"pretty\", \"body\", \"curves\", \"butt\",\n+    \"booty\", \"ass\", \"thighs\", \"legs\", \"figure\", \"bikini\", \"thong\", \"dating\", \"love\", \"flirt\",\n+    \"flirting\", \"romantic\", \"kinky\", \"fetish\", \"xxx\", \"69\", \"blowjob\", \"handjob\", \"deepthroat\",\n+    \"anal\", \"doggy\", \"missionary\", \"threesome\", \"naughty\", \"hookup\", \"one-night\", \"crush\",\n+    \"makeout\", \"smexy\", \"hottie\", \"nips\", \"nipple\", \"nipslip\", \"lick\", \"licking\", \"touch\",\n+    \"caress\", \"moan\", \"moaning\", \"lustful\", \"intimate\", \"intimacy\", \"naughtiness\",\n+    \"provocative\", \"tempting\", \"temptation\", \"entice\", \"spank\", \"dominatrix\", \"submissive\",\n+    \"roleplay\", \"dirty\", \"explicit\", \"vulgar\", \"sensual\", \"romance\", \"playboy\", \"playgirl\",\n+    \"onlyfans\", \"hooker\", \"escort\", \"prostitute\", \"prostitution\", \"brothel\", \"lusting\",\n     \"twerk\", \"twerking\", \"bodycam\", \"cam\", \"suck\", \"sucking\", \"licking\", \"thirsty\"\n }\n VIOLENCE_CONTEXT = {\n-    # --- Physical Violence & Threats ---\n-    \"kill\", \"murder\", \"shoot\", \"stab\", \"bomb\", \"attack\", \"beat\", \"beating\", \"fight\", \n-    \"fighting\", \"hurt\", \"harm\", \"cut\", \"knife\", \"blood\", \"bleed\", \"die\", \"death\", \n-    \"dead\", \"explode\", \"explosion\", \"firebomb\", \"massacre\", \"slaughter\", \"terror\", \n-    \"terrorist\", \"terrorism\", \"suicide\", \"suicidal\", \"execute\", \"execution\", \"hang\", \n-    \"hanging\", \"poison\", \"choke\", \"strangle\", \"shooting\", \"blowup\", \"torture\", \n-    \"assault\", \"crush\", \"destroy\", \"hitman\", \"gun\", \"rifle\", \"pistol\", \"weapon\", \n-    \"grenade\", \"bullet\", \"mine\", \"blast\", \"riot\", \"war\", \"warfare\", \"killself\", \n-    \"jump\", \"bridge\", \"bloodshed\", \"knifeattack\", \"bombblast\", \"massshooting\", \n+    \"kill\", \"murder\", \"shoot\", \"stab\", \"bomb\", \"attack\", \"beat\", \"beating\", \"fight\",\n+    \"fighting\", \"hurt\", \"harm\", \"cut\", \"knife\", \"blood\", \"bleed\", \"die\", \"death\",\n+    \"dead\", \"explode\", \"explosion\", \"firebomb\", \"massacre\", \"slaughter\", \"terror\",\n+    \"terrorist\", \"terrorism\", \"suicide\", \"suicidal\", \"execute\", \"execution\", \"hang\",\n+    \"hanging\", \"poison\", \"choke\", \"strangle\", \"shooting\", \"blowup\", \"torture\",\n+    \"assault\", \"crush\", \"destroy\", \"hitman\", \"gun\", \"rifle\", \"pistol\", \"weapon\",\n+    \"grenade\", \"bullet\", \"mine\", \"blast\", \"riot\", \"war\", \"warfare\", \"killself\",\n+    \"jump\", \"bridge\", \"bloodshed\", \"knifeattack\", \"bombblast\", \"massshooting\",\n     \"explode\", \"abuse\", \"burn\", \"burning\", \"kidnap\", \"rape\", \"rapist\", \"hangman\",\n-\n-    # --- Aggression & Intimidation ---\n-    \"threat\", \"threaten\", \"kill you\", \"beat you\", \"shoot you\", \"stab you\", \n-    \"crush you\", \"destroy you\", \"hurt you\", \"bomb you\", \"die soon\", \"go die\", \n-    \"choke you\", \"slap you\", \"kick you\", \"shootdown\", \"wipeout\", \"obliterate\", \n-    \"cutthroat\", \"hostage\", \"murderer\", \"killer\", \"arson\", \"gang\", \"mafia\", \n-    \"cartel\", \"assassin\", \"suicidebomber\", \"terrorattack\", \"executehim\", \n+    \"threat\", \"threaten\", \"kill you\", \"beat you\", \"shoot you\", \"stab you\",\n+    \"crush you\", \"destroy you\", \"hurt you\", \"bomb you\", \"die soon\", \"go die\",\n+    \"choke you\", \"slap you\", \"kick you\", \"shootdown\", \"wipeout\", \"obliterate\",\n+    \"cutthroat\", \"hostage\", \"murderer\", \"killer\", \"arson\", \"gang\", \"mafia\",\n+    \"cartel\", \"assassin\", \"suicidebomber\", \"terrorattack\", \"executehim\",\n     \"executeher\", \"beatup\", \"knockout\", \"take revenge\", \"revenge\", \"revengeful\",\n-\n-    # --- Hate / Genocidal / Extremist ---\n-    \"nazi\", \"hitler\", \"gaschamber\", \"lynch\", \"lynching\", \"massmurder\", \n-    \"die soon\", \"genocide\", \"holocaust\", \"shootall\", \"slay\", \"slaying\", \n-    \"attackers\", \"terrorcell\", \"jihad\", \"isis\", \"alqaeda\", \"extremist\", \n-    \"terrorgroup\", \"militia\", \"warcriminal\", \"brutal\", \"brutality\", \n-    \"shootout\", \"hijack\", \"hostage\", \"suicideattack\", \"bloodbath\", \n+    \"nazi\", \"hitler\", \"gaschamber\", \"lynch\", \"lynching\", \"massmurder\",\n+    \"genocide\", \"holocaust\", \"shootall\", \"slay\", \"slaying\",\n+    \"attackers\", \"terrorcell\", \"jihad\", \"isis\", \"alqaeda\", \"extremist\",\n+    \"terrorgroup\", \"militia\", \"warcriminal\", \"brutal\", \"brutality\",\n+    \"shootout\", \"hijack\", \"hostage\", \"suicideattack\", \"bloodbath\",\n     \"vengeance\", \"executioner\", \"slaughterhouse\", \"battlefield\", \"murderous\"\n }\n HATE_CONTEXT = {\n-    # --- General Hate Speech ---\n-    \"hate\", \"hateful\", \"disgusting\", \"disgrace\", \"scum\", \"trash\", \"vermin\", \"filth\", \n+    \"hate\", \"hateful\", \"disgusting\", \"disgrace\", \"scum\", \"trash\", \"vermin\", \"filth\",\n     \"worthless\", \"dirty\", \"rotten\", \"evil\", \"ugly\", \"stupid\", \"idiot\", \"freak\", \"loser\",\n     \"disgust\", \"vile\", \"toxic\", \"pig\", \"dog\", \"animal\", \"filthy\", \"garbage\", \"dumb\",\n     \"moron\", \"monster\", \"trashbag\", \"sick\", \"degenerate\", \"disgusted\", \"nasty\", \"witch\",\n     \"whore\", \"slut\", \"bastard\", \"cunt\", \"jerk\", \"retard\", \"psychopath\", \"coward\", \"clown\",\n-\n-    # --- Race & Ethnicity (Global Slurs & Hate) ---\n     \"racist\", \"racism\", \"nigger\", \"negro\", \"chink\", \"gook\", \"beaner\", \"cracker\",\n-    \"redneck\", \"wetback\", \"spic\", \"coon\", \"gypsy\", \"ape\", \"monkey\", \"tribal\", \n+    \"redneck\", \"wetback\", \"spic\", \"coon\", \"gypsy\", \"ape\", \"monkey\", \"tribal\",\n     \"savage\", \"uncivilized\", \"subhuman\", \"slave\", \"jungleman\", \"go back to africa\",\n     \"immigrant trash\", \"white trash\", \"brownie\", \"halfbreed\", \"yellowman\", \"arab terrorist\",\n     \"terrorist\", \"sandnigger\", \"foreign scum\", \"blackie\", \"indiot\", \"hindu freak\",\n-\n-    # --- Religion & Belief ---\n     \"muslimterrorist\", \"muslimdog\", \"jewtrash\", \"antisemite\", \"kike\", \"christfreak\",\n     \"jesusfreak\", \"allahlover\", \"pagan\", \"infidel\", \"devilworshipper\", \"heathen\",\n     \"islamophobic\", \"islamophobia\", \"christophobia\", \"zionistpig\", \"holytrash\",\n     \"churchburner\", \"quranburner\", \"templetrash\", \"buddhafreak\", \"atheistdog\",\n-\n-    # --- Gender & LGBTQ+ Hate ---\n     \"gay\", \"faggot\", \"lesbo\", \"dyke\", \"tranny\", \"transfreak\", \"queer\", \"homo\", \"gaytrash\",\n     \"gendertrash\", \"crossdresser\", \"she-male\", \"ladyboy\", \"sissy\", \"feminazi\", \"misogynist\",\n     \"bitch\", \"whore\", \"slut\", \"hoe\", \"gold-digger\", \"skank\", \"femalescum\", \"manhater\",\n     \"toxicman\", \"gaylover\", \"rainbowtrash\", \"shemale\", \"queerfreak\", \"transhate\",\n-\n-    # --- Nationality / Region Hate ---\n     \"paki\", \"chinesevirus\", \"indiantrash\", \"filipinotrash\", \"mexicantrash\", \"japtrash\",\n     \"arabtrash\", \"blacktrash\", \"whitepig\", \"americandog\", \"chinklover\", \"asianpig\",\n     \"europeanscum\", \"africantrash\", \"indiandog\", \"russianpig\", \"ukrainiantrash\",\n     \"italianmafia\", \"irishdrunk\", \"africanmonkey\", \"browntrash\", \"latinopig\",\n-\n-    # --- Political / Ideological Hate ---\n     \"nazi\", \"fascist\", \"commie\", \"communistpig\", \"lefttrash\", \"righttrash\", \"wokefreak\",\n-    \"snowflake\", \"libtard\", \"reptilian\", \"marxist\", \"extremist\", \"terrorlover\", \n+    \"snowflake\", \"libtard\", \"reptilian\", \"marxist\", \"extremist\", \"terrorlover\",\n     \"redtrash\", \"bluepig\", \"demofreak\", \"repubfreak\", \"dictatorlover\",\n-\n-    # --- Targeted Violence & Hate Intent ---\n-    \"burnthem\", \"killthem\", \"destroythem\", \"shootthem\", \"wipeout\", \"exterminate\", \n+    \"burnthem\", \"killthem\", \"destroythem\", \"shootthem\", \"wipeout\", \"exterminate\",\n     \"hangthem\", \"dieall\", \"bombthem\", \"nuke\", \"eradicate\", \"masskill\", \"go back\",\n     \"send them home\", \"get out\", \"not welcome\", \"you people\", \"your kind\", \"they all stink\",\n     \"hate group\", \"whitepower\", \"blmtrash\", \"kkk\", \"neo-nazi\", \"skinhead\", \"supremacist\",\n     \"gaschamber\", \"lynch\", \"execute\", \"no lives matter\", \"hatecrime\"\n }\n MENTAL_HEALTH_CONTEXT = {\n-    # --- Depression & Sadness ---\n     \"depressed\", \"sad\", \"hopeless\", \"worthless\", \"numb\", \"lonely\", \"miserable\", \"exhausted\",\n     \"tiredoflife\", \"crying\", \"pain\", \"hurt\", \"useless\", \"empty\", \"lost\", \"dark\", \"lifeless\",\n     \"can‚Äôt go on\", \"pointless\", \"suffering\", \"no one cares\", \"hate myself\", \"broken\", \"meaningless\",\n     \"failed\", \"failure\", \"donewithlife\", \"lowenergy\", \"mentalpain\", \"despair\",\n-\n-    # --- Anxiety & Panic ---\n     \"anxiety\", \"panic\", \"scared\", \"fear\", \"overthinking\", \"nervous\", \"shaking\", \"paranoid\",\n     \"can‚Äôt breathe\", \"panicattack\", \"heart racing\", \"stress\", \"worry\", \"suffocating\",\n     \"fearful\", \"terrified\", \"no control\", \"helpless\", \"triggered\", \"anxious\", \"nervousbreakdown\",\n-\n-    # --- Self-Harm & Suicide ---\n     \"suicide\", \"kill myself\", \"end my life\", \"want to die\", \"cut myself\", \"selfharm\",\n     \"slit my wrist\", \"i‚Äôm done\", \"die\", \"jump off\", \"no reason to live\", \"goodbye forever\",\n     \"it‚Äôs over\", \"drinking bleach\", \"take pills\", \"not waking up\", \"hang myself\",\n     \"bleed out\", \"can‚Äôt handle\", \"done living\", \"kill me\", \"suffocate\", \"overdose\",\n     \"i‚Äôm tired of living\", \"i want to disappear\", \"self destruction\", \"goodbye world\",\n-\n-    # --- Bullying-Related Mental Pressure ---\n-    \"bullied\", \"they mock me\", \"i‚Äôm nothing\", \"they hate me\", \"everyone laughs\", \n+    \"bullied\", \"they mock me\", \"i‚Äôm nothing\", \"they hate me\", \"everyone laughs\",\n     \"embarrassed\", \"humiliated\", \"excluded\", \"unwanted\", \"rejected\", \"ignored\",\n     \"no friends\", \"outcast\", \"they call me names\", \"i hate school\", \"hate everyone\",\n     \"they make fun of me\", \"i‚Äôm ugly\", \"i‚Äôm stupid\", \"no one loves me\", \"can‚Äôt fit in\",\n-\n-    # --- Trauma / PTSD / Abuse ---\n     \"trauma\", \"abuse\", \"molested\", \"raped\", \"beaten\", \"hurt inside\", \"broken soul\",\n     \"can‚Äôt sleep\", \"nightmares\", \"flashbacks\", \"traumatized\", \"crisis\", \"abandoned\",\n     \"controlled\", \"gaslight\", \"manipulated\", \"trapped\", \"fear of people\", \"haunted\",\n     \"can‚Äôt trust anyone\", \"no escape\", \"mentalbreak\", \"suffering inside\",\n-\n-    # --- Mental Illness / Conditions ---\n     \"adhd\", \"bipolar\", \"schizophrenia\", \"psychosis\", \"ocd\", \"addiction\", \"autistic\",\n     \"borderline\", \"personalitydisorder\", \"eatingdisorder\", \"anorexia\", \"bulimia\",\n     \"alcoholic\", \"drugaddict\", \"mentallyill\", \"crazy\", \"insane\", \"psycho\", \"mad\", \"delusional\",\n-\n-    # --- Encouraging Self-Harm / Negativity ---\n     \"you should die\", \"nobody cares\", \"kill yourself\", \"drink bleach\", \"you‚Äôre worthless\",\n     \"no one loves you\", \"cut deeper\", \"just die\", \"go kill yourself\", \"hang yourself\",\n     \"nobody would miss you\", \"do it already\", \"you‚Äôre a failure\", \"you‚Äôre disgusting\",\n     \"why are you alive\", \"you‚Äôre a loser\", \"you deserve to die\", \"nobody likes you\",\n     \"you should disappear\", \"your life is a joke\", \"kill yourself now\",\n-\n-    # --- Counseling / Help Phrases (Detection of Suicidal Intent) ---\n     \"need help\", \"talk to someone\", \"therapy\", \"mental health\", \"counseling\",\n     \"helpline\", \"i want to talk\", \"need support\", \"i feel weak\", \"can‚Äôt do this\",\n     \"i want to see a therapist\", \"help me\", \"i‚Äôm scared\", \"save me\", \"please listen\",\n     \"nobody understands\", \"crisis hotline\", \"need someone to talk to\"\n@@ -208,23 +176,39 @@\n         return datetime.fromtimestamp(value).strftime(\"%Y-%m-%d %H:%M:%S\")\n     except Exception:\n         return \"N/A\"\n \n-\n templates.env.filters[\"datetimeformat\"] = datetimeformat\n \n \n+def log_prediction_data(text, label):\n+    log_path = BASE_DIR / \"predictions_log.json\"\n+    entry = {\"text\": text, \"label\": label, \"timestamp\": time.time()}\n+    data = []\n+    if log_path.exists():\n+        try:\n+            data = json.loads(log_path.read_text())\n+        except Exception:\n+            data = []\n+    data.append(entry)\n+    log_path.write_text(json.dumps(data, indent=2))\n+\n # ---------------------------------------------------\n # DETECTION LOGIC\n # ---------------------------------------------------\n def predict_text(text: str, use_transformer: bool = False):\n+    \"\"\"\n+    Rule-based context ‚Üí Transformer (optional) ‚Üí Fallback TF-IDF\n+    \"\"\"\n     global transformer_pipeline\n     text_low = text.lower()\n     model_used = \"Fallback TF-IDF\"\n \n     def match_any(words):\n+        # substring match is intentional to catch plural / variants\n         return any(w in text_low for w in words)\n \n+    # 1) Rule-based immediate flags\n     if match_any(SEXUAL_CONTEXT):\n         return \"Cyberbullying\", 0.99, \"Sexual Harassment\"\n     if match_any(VIOLENCE_CONTEXT):\n         return \"Cyberbullying\", 0.97, \"Violence/Threat\"\n@@ -232,54 +216,41 @@\n         return \"Cyberbullying\", 0.96, \"Insult/Hate\"\n     if match_any(MENTAL_HEALTH_CONTEXT):\n         return \"Cyberbullying\", 0.94, \"Mental Health Abuse\"\n \n-    # Transformer\n+    # 2) Transformer (if asked)\n     if use_transformer:\n         try:\n             from transformers import pipeline\n+            model_name = str(LOCAL_TRANSFORMER_DIR) if LOCAL_TRANSFORMER_DIR.exists() else \"unitary/toxic-bert\"\n             if transformer_pipeline is None:\n-                transformer_pipeline = pipeline(\"text-classification\", model=\"unitary/toxic-bert\", device=-1)\n+                print(f\"üîÑ Loading transformer model from: {model_name}\")\n+                transformer_pipeline = pipeline(\"text-classification\", model=model_name, device=-1)\n             pred = transformer_pipeline(text, truncation=True)[0]\n-            label = \"Cyberbullying\" if \"toxic\" in pred[\"label\"].lower() else \"Non-Cyberbullying\"\n-            return label, pred[\"score\"], \"Transformer\"\n+            label = \"Cyberbullying\" if \"toxic\" in pred[\"label\"].lower() or pred[\"label\"].lower() in {\"label_1\", \"negative\"} else \"Non-Cyberbullying\"\n+            return label, float(pred.get(\"score\", 0.0)), f\"Transformer ({model_name})\"\n         except Exception as e:\n             print(\"Transformer error:\", e)\n \n+    # 3) Fallback TF-IDF\n     if FALLBACK is None:\n         return \"Error\", 0.0, \"No model\"\n-\n     try:\n         pred = FALLBACK.predict([text])[0]\n-        prob = float(FALLBACK.predict_proba([text])[0][1])\n+        prob = float(FALLBACK.predict_proba([text])[0][1]) if hasattr(FALLBACK, \"predict_proba\") else 0.0\n         label = \"Cyberbullying\" if pred == 1 else \"Non-Cyberbullying\"\n         return label, prob, model_used\n     except Exception as e:\n         print(f\"Fallback error: {e}\")\n         return \"Error\", 0.0, \"Fallback Error\"\n \n-\n-def log_prediction_data(text, label):\n-    log_path = BASE_DIR / \"predictions_log.json\"\n-    entry = {\"text\": text, \"label\": label, \"timestamp\": time.time()}\n-    data = []\n-    if log_path.exists():\n-        try:\n-            data = json.loads(log_path.read_text())\n-        except Exception:\n-            data = []\n-    data.append(entry)\n-    log_path.write_text(json.dumps(data, indent=2))\n-\n-\n # ---------------------------------------------------\n-# ROUTES\n+# ROUTES: PAGES\n # ---------------------------------------------------\n @app.get(\"/\", response_class=HTMLResponse)\n async def home(request: Request):\n     return templates.TemplateResponse(\"index.html\", {\"request\": request, \"result\": None})\n \n-\n @app.post(\"/predict\", response_class=HTMLResponse)\n async def predict(request: Request, text: str = Form(...), use_transformer: str = Form(\"no\")):\n     use_transformer = use_transformer.lower() in [\"yes\", \"on\", \"true\"]\n     label, prob, model_used = predict_text(text, use_transformer)\n@@ -288,49 +259,42 @@\n         \"index.html\",\n         {\"request\": request, \"result\": {\"text\": text, \"label\": label, \"prob\": prob, \"model\": model_used}},\n     )\n \n-\n @app.get(\"/dashboard\", response_class=HTMLResponse)\n async def dashboard(request: Request):\n     user = request.session.get(\"user\")\n     if not user:\n         return RedirectResponse(\"/login\")\n-\n     log_path = BASE_DIR / \"predictions_log.json\"\n     stats = {\"total\": 0, \"bullying\": 0, \"non\": 0, \"recent\": []}\n     if log_path.exists():\n         data = json.loads(log_path.read_text())\n         stats[\"total\"] = len(data)\n         stats[\"recent\"] = data[-10:][::-1]\n         stats[\"bullying\"] = sum(1 for d in data if d[\"label\"] == \"Cyberbullying\")\n         stats[\"non\"] = stats[\"total\"] - stats[\"bullying\"]\n-\n     return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": user})\n \n-\n # ---------------------------------------------------\n # AUTH ROUTES (LOGIN / LOGOUT / REGISTER)\n # ---------------------------------------------------\n @app.get(\"/login\", response_class=HTMLResponse)\n async def login_page(request: Request):\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"\"})\n \n-\n @app.post(\"/login\", response_class=HTMLResponse)\n async def login_user(request: Request, username: str = Form(...), password: str = Form(...)):\n     users = get_users()\n     if username in users and users[username][\"password\"] == password:\n         request.session[\"user\"] = username\n         return RedirectResponse(\"/dashboard\", status_code=303)\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚ùå Invalid credentials\"})\n \n-\n @app.get(\"/register\", response_class=HTMLResponse)\n async def register_page(request: Request):\n     return templates.TemplateResponse(\"register.html\", {\"request\": request, \"message\": \"\"})\n \n-\n @app.post(\"/register\", response_class=HTMLResponse)\n async def register_user(request: Request, username: str = Form(...), password: str = Form(...)):\n     users = get_users()\n     if username in users:\n@@ -338,9 +302,49 @@\n     users[username] = {\"password\": password}\n     save_users(users)\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚úÖ Registered successfully! Please log in.\"})\n \n-\n @app.get(\"/logout\")\n async def logout(request: Request):\n     request.session.clear()\n     return RedirectResponse(\"/\", status_code=303)\n+\n+# ---------------------------------------------------\n+# TRAINING ROUTES (kept)\n+# ---------------------------------------------------\n+@app.get(\"/train_transformer\", response_class=HTMLResponse)\n+async def train_transformer_page(request: Request):\n+    # protect training behind login (optional)\n+    if not request.session.get(\"user\"):\n+        return RedirectResponse(\"/login\")\n+    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"user\": request.session.get(\"user\")})\n+\n+@app.post(\"/train_transformer\", response_class=HTMLResponse)\n+async def train_transformer_post(\n+    request: Request,\n+    file: UploadFile = File(...),\n+    background_tasks: BackgroundTasks = None\n+):\n+    if not request.session.get(\"user\"):\n+        return RedirectResponse(\"/login\")\n+    content = await file.read()\n+    csv_path = BASE_DIR / f\"uploaded_{int(time.time())}.csv\"\n+    csv_path.write_bytes(content)\n+\n+    def run_training():\n+        status_log = BASE_DIR / \"train_status.log\"\n+        try:\n+            status_log.write_text(\"Training started...\\n\")\n+            model_path = train_transformer_model(str(csv_path))\n+            status_log.write_text(f\"‚úÖ Model trained successfully at: {model_path}\\n\")\n+        except Exception as e:\n+            status_log.write_text(f\"‚ùå Training failed: {e}\\n\")\n+\n+    background_tasks.add_task(run_training)\n+    message = \"üöÄ Training started. Check this page in a bit to see the status.\"\n+    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": message, \"user\": request.session.get(\"user\")})\n+\n+@app.get(\"/train_status\", response_class=HTMLResponse)\n+async def train_status(request: Request):\n+    status_log = BASE_DIR / \"train_status.log\"\n+    msg = status_log.read_text(encoding=\"utf-8\") if status_log.exists() else \"Training not started or running...\"\n+    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": msg, \"user\": request.session.get(\"user\")})\n"
                },
                {
                    "date": 1762602108442,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,8 +59,40 @@\n \n # ---------------------------------------------------\n # CONTEXT WORD LISTS (as provided)\n # ---------------------------------------------------\n+DIRTY_WORDS = {\n+    # --- General Obscene Words ---\n+    \"fuck\", \"fucking\", \"fucker\", \"motherfucker\", \"bullshit\", \"shit\", \"crap\", \"asshole\",\n+    \"bastard\", \"dickhead\", \"pussy\", \"cock\", \"cum\", \"cumming\", \"dildo\", \"vibrator\", \"porn\",\n+    \"porno\", \"pornography\", \"bitch\", \"slut\", \"whore\", \"hoe\", \"skank\", \"cunt\", \"fag\",\n+    \"faggot\", \"jerkoff\", \"handjob\", \"blowjob\", \"deepthroat\", \"anal\", \"anus\", \"ass\",\n+    \"booty\", \"butt\", \"butthole\", \"tits\", \"boobs\", \"nipple\", \"nips\", \"nipslip\", \"thong\",\n+    \"panties\", \"underwear\", \"bra\", \"strip\", \"stripper\", \"nude\", \"naked\", \"bare\", \"banging\",\n+    \"bang\", \"bed\", \"bedroom\", \"doggystyle\", \"69\", \"sex\", \"sexual\", \"intercourse\",\n+    \"masturbate\", \"masturbation\", \"orgasm\", \"suck\", \"sucking\", \"lick\", \"licking\", \"moan\",\n+    \"moaning\", \"spank\", \"spanking\", \"fetish\", \"horny\", \"kinky\", \"erotic\", \"seduce\",\n+    \"seducing\", \"seduction\", \"sensual\", \"lust\", \"lusting\", \"thirsty\", \"threesome\",\n+    \"one-night\", \"hookup\", \"crush\", \"dating\", \"flirt\", \"flirting\", \"naughty\", \"hottie\",\n+    \"sexy\", \"hot\", \"babe\", \"beautiful\", \"gorgeous\", \"handsome\", \"body\", \"curves\", \"figure\",\n+    \"legs\", \"thighs\", \"booty\", \"ass\", \"butt\", \"spank\", \"fuckboy\", \"fuckgirl\", \"slutty\",\n+    \"banging\", \"sexchat\", \"nudes\", \"onlyfans\", \"playboy\", \"playgirl\", \"camgirl\", \"escort\",\n+    \"hooker\", \"prostitute\", \"brothel\", \"twerk\", \"twerking\", \"dominatrix\", \"submissive\",\n+    \"dirtytalk\", \"bdsm\", \"roleplay\", \"sexslave\", \"cumshot\", \"facial\", \"orgy\", \"ejaculate\",\n+    \"ejaculation\", \"vagina\", \"clit\", \"clitoris\", \"penis\", \"balls\", \"testicles\", \"scrotum\",\n+    \"pussyjuice\", \"blow\", \"handjob\", \"suckoff\", \"rimjob\", \"analplay\", \"pegging\", \"gspot\",\n+    \"cocksucker\", \"dickpic\", \"nudes\", \"cam\", \"bodycam\", \"busty\", \"milf\", \"gilf\", \"teen\",\n+    \"collegegirl\", \"shemale\", \"ladyboy\", \"crossdresser\", \"tranny\", \"pornstar\", \"nipslip\",\n+    \"striptease\", \"lapdance\", \"whip\", \"chains\", \"bondage\", \"orgy\", \"deep\", \"cream\",\n+    \"creamypie\", \"gag\", \"gagging\", \"dominant\", \"slave\", \"sexslave\", \"fingering\",\n+    \"penetrate\", \"penetration\", \"vibrator\", \"buttplug\", \"kamasutra\", \"lingerie\",\n+    \"tempting\", \"temptation\", \"naughtiness\", \"explicit\", \"vulgar\", \"adult\", \"fetish\",\n+    \"dirty\", \"smexy\", \"lustful\", \"foreplay\", \"romance\", \"xxx\", \"69ing\", \"wet\", \"moist\",\n+    \"cumslut\", \"porns\", \"boobjob\", \"spitroast\", \"gangbang\", \"roughsex\", \"nips\", \"peep\",\n+    \"sexually\", \"touch\", \"caress\", \"grope\", \"fondle\", \"rub\", \"rubbing\", \"massage\", \"oral\",\n+    \"kiss\", \"makeout\", \"deepkiss\", \"fucktoy\", \"pornhub\", \"xvideos\", \"redtube\", \"xnxx\"\n+}\n+\n SEXUAL_CONTEXT = {\n     \"sex\", \"sexual\", \"nude\", \"naked\", \"boobs\", \"breast\", \"tits\", \"bra\", \"panty\", \"underwear\",\n     \"kiss\", \"kissing\", \"hot\", \"sexy\", \"horny\", \"babe\", \"lust\", \"adult\", \"erotic\", \"fetish\",\n     \"porn\", \"porno\", \"pornography\", \"camgirl\", \"camguy\", \"strip\", \"stripper\", \"striptease\",\n@@ -207,8 +239,10 @@\n         # substring match is intentional to catch plural / variants\n         return any(w in text_low for w in words)\n \n     # 1) Rule-based immediate flags\n+    if match_any(DIRTY_WORDS):\n+        return \"Cyberbullying\", 0.99, \"Sexual/Obscene Language\"\n     if match_any(SEXUAL_CONTEXT):\n         return \"Cyberbullying\", 0.99, \"Sexual Harassment\"\n     if match_any(VIOLENCE_CONTEXT):\n         return \"Cyberbullying\", 0.97, \"Violence/Threat\"\n"
                },
                {
                    "date": 1762602663385,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,11 +41,16 @@\n \n \n def get_users():\n     try:\n-        return json.loads(USER_FILE.read_text())\n+        data = json.loads(USER_FILE.read_text())\n+        if isinstance(data, list):  # ‚ùå Fix old format\n+            data = {u[\"username\"]: {\"password\": u[\"password\"]} for u in data}\n+        elif not isinstance(data, dict):  # If file corrupted\n+            data = {}\n+        return data\n     except Exception:\n-        return {}\n+        return {\"admin\": {\"password\": \"password\"}}\n \n \n def save_users(users):\n     USER_FILE.write_text(json.dumps(users, indent=2))\n"
                },
                {
                    "date": 1762603297307,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -381,9 +381,20 @@\n     background_tasks.add_task(run_training)\n     message = \"üöÄ Training started. Check this page in a bit to see the status.\"\n     return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": message, \"user\": request.session.get(\"user\")})\n \n-@app.get(\"/train_status\", response_class=HTMLResponse)\n-async def train_status(request: Request):\n-    status_log = BASE_DIR / \"train_status.log\"\n-    msg = status_log.read_text(encoding=\"utf-8\") if status_log.exists() else \"Training not started or running...\"\n-    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": msg, \"user\": request.session.get(\"user\")})\n+@app.get(\"/train_logs\")\n+async def stream_training_logs():\n+    log_path = BASE_DIR / \"train_status.log\"\n+    def log_stream():\n+        try:\n+            with open(log_path, \"r\", encoding=\"utf-8\") as file:\n+                # Continuously yield new lines\n+                while True:\n+                    line = file.readline()\n+                    if line:\n+                        yield line\n+                    else:\n+                        time.sleep(0.5)\n+        except Exception as e:\n+            yield f\"Error reading log: {str(e)}\"\n+    return StreamingResponse(log_stream(), media_type=\"text/plain\")\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762604195081,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,11 +1,10 @@\n-# main.py\n-from fastapi import FastAPI, Request, Form, UploadFile, File, Depends, HTTPException, BackgroundTasks\n-from fastapi.responses import HTMLResponse, RedirectResponse, JSONResponse\n+from fastapi import FastAPI, Request, Form, UploadFile, File, HTTPException, BackgroundTasks\n+from fastapi.responses import HTMLResponse, RedirectResponse, StreamingResponse\n from fastapi.staticfiles import StaticFiles\n from fastapi.templating import Jinja2Templates\n from starlette.middleware.sessions import SessionMiddleware\n-import joblib, os, json, time\n+import joblib, os, json, time, asyncio\n from pathlib import Path\n from datetime import datetime\n from train_transformer import train_transformer_model\n \n@@ -15,26 +14,25 @@\n app = FastAPI(title=\"Cyberbullying Detection System\")\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n-app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")  # keep a strong key in prod\n+app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n \n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n-FALLBACK = None\n try:\n     FALLBACK = joblib.load(BASE_DIR / \"model.pkl\")\n     print(\"‚úÖ Loaded fallback model (model.pkl).\")\n except Exception as e:\n     print(f\"‚ö†Ô∏è Fallback model not found: {e}\")\n+    FALLBACK = None\n \n-# transformer (lazy)\n transformer_pipeline = None\n-LOCAL_TRANSFORMER_DIR = BASE_DIR / \"models\" / \"transformer_model\"  # where training saves\n+LOCAL_TRANSFORMER_DIR = BASE_DIR / \"models\" / \"transformer_model\"\n \n # ---------------------------------------------------\n-# USER MANAGEMENT (login, register, logout)\n+# USER MANAGEMENT\n # ---------------------------------------------------\n USER_FILE = BASE_DIR / \"users.json\"\n if not USER_FILE.exists():\n     USER_FILE.write_text(json.dumps({\"admin\": {\"password\": \"password\"}}, indent=2))\n@@ -42,11 +40,11 @@\n \n def get_users():\n     try:\n         data = json.loads(USER_FILE.read_text())\n-        if isinstance(data, list):  # ‚ùå Fix old format\n+        if isinstance(data, list):\n             data = {u[\"username\"]: {\"password\": u[\"password\"]} for u in data}\n-        elif not isinstance(data, dict):  # If file corrupted\n+        elif not isinstance(data, dict):\n             data = {}\n         return data\n     except Exception:\n         return {\"admin\": {\"password\": \"password\"}}\n@@ -55,155 +53,73 @@\n def save_users(users):\n     USER_FILE.write_text(json.dumps(users, indent=2))\n \n \n-def get_current_user(request: Request):\n-    user = request.session.get(\"user\")\n-    if not user:\n-        raise HTTPException(status_code=401, detail=\"Unauthorized\")\n-    return user\n-\n # ---------------------------------------------------\n-# CONTEXT WORD LISTS (as provided)\n+# CONTEXT WORD LISTS\n # ---------------------------------------------------\n+# ü©∂ DIRTY / SEXUAL / VIOLENCE / HATE / MENTAL HEALTH\n DIRTY_WORDS = {\n-    # --- General Obscene Words ---\n     \"fuck\", \"fucking\", \"fucker\", \"motherfucker\", \"bullshit\", \"shit\", \"crap\", \"asshole\",\n     \"bastard\", \"dickhead\", \"pussy\", \"cock\", \"cum\", \"cumming\", \"dildo\", \"vibrator\", \"porn\",\n     \"porno\", \"pornography\", \"bitch\", \"slut\", \"whore\", \"hoe\", \"skank\", \"cunt\", \"fag\",\n     \"faggot\", \"jerkoff\", \"handjob\", \"blowjob\", \"deepthroat\", \"anal\", \"anus\", \"ass\",\n-    \"booty\", \"butt\", \"butthole\", \"tits\", \"boobs\", \"nipple\", \"nips\", \"nipslip\", \"thong\",\n-    \"panties\", \"underwear\", \"bra\", \"strip\", \"stripper\", \"nude\", \"naked\", \"bare\", \"banging\",\n-    \"bang\", \"bed\", \"bedroom\", \"doggystyle\", \"69\", \"sex\", \"sexual\", \"intercourse\",\n-    \"masturbate\", \"masturbation\", \"orgasm\", \"suck\", \"sucking\", \"lick\", \"licking\", \"moan\",\n-    \"moaning\", \"spank\", \"spanking\", \"fetish\", \"horny\", \"kinky\", \"erotic\", \"seduce\",\n-    \"seducing\", \"seduction\", \"sensual\", \"lust\", \"lusting\", \"thirsty\", \"threesome\",\n-    \"one-night\", \"hookup\", \"crush\", \"dating\", \"flirt\", \"flirting\", \"naughty\", \"hottie\",\n-    \"sexy\", \"hot\", \"babe\", \"beautiful\", \"gorgeous\", \"handsome\", \"body\", \"curves\", \"figure\",\n-    \"legs\", \"thighs\", \"booty\", \"ass\", \"butt\", \"spank\", \"fuckboy\", \"fuckgirl\", \"slutty\",\n-    \"banging\", \"sexchat\", \"nudes\", \"onlyfans\", \"playboy\", \"playgirl\", \"camgirl\", \"escort\",\n-    \"hooker\", \"prostitute\", \"brothel\", \"twerk\", \"twerking\", \"dominatrix\", \"submissive\",\n-    \"dirtytalk\", \"bdsm\", \"roleplay\", \"sexslave\", \"cumshot\", \"facial\", \"orgy\", \"ejaculate\",\n-    \"ejaculation\", \"vagina\", \"clit\", \"clitoris\", \"penis\", \"balls\", \"testicles\", \"scrotum\",\n-    \"pussyjuice\", \"blow\", \"handjob\", \"suckoff\", \"rimjob\", \"analplay\", \"pegging\", \"gspot\",\n-    \"cocksucker\", \"dickpic\", \"nudes\", \"cam\", \"bodycam\", \"busty\", \"milf\", \"gilf\", \"teen\",\n-    \"collegegirl\", \"shemale\", \"ladyboy\", \"crossdresser\", \"tranny\", \"pornstar\", \"nipslip\",\n-    \"striptease\", \"lapdance\", \"whip\", \"chains\", \"bondage\", \"orgy\", \"deep\", \"cream\",\n-    \"creamypie\", \"gag\", \"gagging\", \"dominant\", \"slave\", \"sexslave\", \"fingering\",\n-    \"penetrate\", \"penetration\", \"vibrator\", \"buttplug\", \"kamasutra\", \"lingerie\",\n-    \"tempting\", \"temptation\", \"naughtiness\", \"explicit\", \"vulgar\", \"adult\", \"fetish\",\n-    \"dirty\", \"smexy\", \"lustful\", \"foreplay\", \"romance\", \"xxx\", \"69ing\", \"wet\", \"moist\",\n-    \"cumslut\", \"porns\", \"boobjob\", \"spitroast\", \"gangbang\", \"roughsex\", \"nips\", \"peep\",\n-    \"sexually\", \"touch\", \"caress\", \"grope\", \"fondle\", \"rub\", \"rubbing\", \"massage\", \"oral\",\n-    \"kiss\", \"makeout\", \"deepkiss\", \"fucktoy\", \"pornhub\", \"xvideos\", \"redtube\", \"xnxx\"\n+    \"booty\", \"butt\", \"butthole\", \"tits\", \"boobs\", \"nipple\", \"nips\", \"thong\", \"panties\",\n+    \"underwear\", \"bra\", \"strip\", \"stripper\", \"nude\", \"naked\", \"banging\", \"bang\", \"bed\",\n+    \"doggystyle\", \"69\", \"sex\", \"sexual\", \"intercourse\", \"masturbate\", \"orgasm\", \"suck\",\n+    \"lick\", \"moan\", \"spank\", \"fetish\", \"horny\", \"kinky\", \"erotic\", \"seduce\", \"sensual\",\n+    \"lust\", \"threesome\", \"hookup\", \"flirt\", \"naughty\", \"hottie\", \"sexy\", \"babe\", \"beautiful\",\n+    \"handsome\", \"curves\", \"legs\", \"thighs\", \"booty\", \"fuckboy\", \"fuckgirl\", \"slutty\",\n+    \"nudes\", \"onlyfans\", \"playboy\", \"playgirl\", \"camgirl\", \"escort\", \"hooker\", \"prostitute\",\n+    \"twerk\", \"dominatrix\", \"submissive\", \"bdsm\", \"roleplay\", \"sexslave\", \"cumshot\",\n+    \"vagina\", \"penis\", \"balls\", \"pussyjuice\", \"rimjob\", \"pegging\", \"gspot\", \"cocksucker\",\n+    \"nipslip\", \"lapdance\", \"whip\", \"chains\", \"bondage\", \"creamypie\", \"dominant\", \"slave\",\n+    \"penetration\", \"buttplug\", \"kamasutra\", \"lingerie\", \"tempting\", \"vulgar\", \"adult\",\n+    \"xxx\", \"wet\", \"moist\", \"pornhub\", \"xvideos\", \"xnxx\"\n }\n \n SEXUAL_CONTEXT = {\n     \"sex\", \"sexual\", \"nude\", \"naked\", \"boobs\", \"breast\", \"tits\", \"bra\", \"panty\", \"underwear\",\n     \"kiss\", \"kissing\", \"hot\", \"sexy\", \"horny\", \"babe\", \"lust\", \"adult\", \"erotic\", \"fetish\",\n-    \"porn\", \"porno\", \"pornography\", \"camgirl\", \"camguy\", \"strip\", \"stripper\", \"striptease\",\n-    \"seduce\", \"seducing\", \"seduction\", \"aroused\", \"arousal\", \"orgasm\", \"masturbate\",\n-    \"masturbation\", \"cock\", \"dick\", \"penis\", \"pussy\", \"vagina\", \"clit\", \"clitoris\", \"cum\",\n-    \"sperm\", \"ejaculate\", \"ejaculation\", \"wet\", \"naughty\", \"bedroom\", \"foreplay\", \"lingerie\",\n-    \"modeling\", \"handsome\", \"beautiful\", \"gorgeous\", \"pretty\", \"body\", \"curves\", \"butt\",\n-    \"booty\", \"ass\", \"thighs\", \"legs\", \"figure\", \"bikini\", \"thong\", \"dating\", \"love\", \"flirt\",\n-    \"flirting\", \"romantic\", \"kinky\", \"fetish\", \"xxx\", \"69\", \"blowjob\", \"handjob\", \"deepthroat\",\n-    \"anal\", \"doggy\", \"missionary\", \"threesome\", \"naughty\", \"hookup\", \"one-night\", \"crush\",\n-    \"makeout\", \"smexy\", \"hottie\", \"nips\", \"nipple\", \"nipslip\", \"lick\", \"licking\", \"touch\",\n-    \"caress\", \"moan\", \"moaning\", \"lustful\", \"intimate\", \"intimacy\", \"naughtiness\",\n-    \"provocative\", \"tempting\", \"temptation\", \"entice\", \"spank\", \"dominatrix\", \"submissive\",\n-    \"roleplay\", \"dirty\", \"explicit\", \"vulgar\", \"sensual\", \"romance\", \"playboy\", \"playgirl\",\n-    \"onlyfans\", \"hooker\", \"escort\", \"prostitute\", \"prostitution\", \"brothel\", \"lusting\",\n-    \"twerk\", \"twerking\", \"bodycam\", \"cam\", \"suck\", \"sucking\", \"licking\", \"thirsty\"\n+    \"porn\", \"camgirl\", \"strip\", \"stripper\", \"seduce\", \"aroused\", \"orgasm\", \"masturbate\",\n+    \"cock\", \"pussy\", \"vagina\", \"cum\", \"wet\", \"naughty\", \"foreplay\", \"lingerie\", \"body\",\n+    \"curves\", \"butt\", \"booty\", \"ass\", \"legs\", \"bikini\", \"flirt\", \"romantic\", \"kinky\",\n+    \"blowjob\", \"handjob\", \"anal\", \"threesome\", \"hookup\", \"makeout\", \"hottie\", \"nipslip\",\n+    \"lick\", \"moan\", \"spank\", \"dirty\", \"explicit\", \"vulgar\", \"sensual\", \"romance\", \"playboy\",\n+    \"onlyfans\", \"escort\", \"prostitute\", \"brothel\", \"twerk\", \"twerking\", \"suck\", \"licking\"\n }\n+\n VIOLENCE_CONTEXT = {\n-    \"kill\", \"murder\", \"shoot\", \"stab\", \"bomb\", \"attack\", \"beat\", \"beating\", \"fight\",\n-    \"fighting\", \"hurt\", \"harm\", \"cut\", \"knife\", \"blood\", \"bleed\", \"die\", \"death\",\n-    \"dead\", \"explode\", \"explosion\", \"firebomb\", \"massacre\", \"slaughter\", \"terror\",\n-    \"terrorist\", \"terrorism\", \"suicide\", \"suicidal\", \"execute\", \"execution\", \"hang\",\n-    \"hanging\", \"poison\", \"choke\", \"strangle\", \"shooting\", \"blowup\", \"torture\",\n-    \"assault\", \"crush\", \"destroy\", \"hitman\", \"gun\", \"rifle\", \"pistol\", \"weapon\",\n-    \"grenade\", \"bullet\", \"mine\", \"blast\", \"riot\", \"war\", \"warfare\", \"killself\",\n-    \"jump\", \"bridge\", \"bloodshed\", \"knifeattack\", \"bombblast\", \"massshooting\",\n-    \"explode\", \"abuse\", \"burn\", \"burning\", \"kidnap\", \"rape\", \"rapist\", \"hangman\",\n-    \"threat\", \"threaten\", \"kill you\", \"beat you\", \"shoot you\", \"stab you\",\n-    \"crush you\", \"destroy you\", \"hurt you\", \"bomb you\", \"die soon\", \"go die\",\n-    \"choke you\", \"slap you\", \"kick you\", \"shootdown\", \"wipeout\", \"obliterate\",\n-    \"cutthroat\", \"hostage\", \"murderer\", \"killer\", \"arson\", \"gang\", \"mafia\",\n-    \"cartel\", \"assassin\", \"suicidebomber\", \"terrorattack\", \"executehim\",\n-    \"executeher\", \"beatup\", \"knockout\", \"take revenge\", \"revenge\", \"revengeful\",\n-    \"nazi\", \"hitler\", \"gaschamber\", \"lynch\", \"lynching\", \"massmurder\",\n-    \"genocide\", \"holocaust\", \"shootall\", \"slay\", \"slaying\",\n-    \"attackers\", \"terrorcell\", \"jihad\", \"isis\", \"alqaeda\", \"extremist\",\n-    \"terrorgroup\", \"militia\", \"warcriminal\", \"brutal\", \"brutality\",\n-    \"shootout\", \"hijack\", \"hostage\", \"suicideattack\", \"bloodbath\",\n-    \"vengeance\", \"executioner\", \"slaughterhouse\", \"battlefield\", \"murderous\"\n+    \"kill\", \"murder\", \"shoot\", \"stab\", \"bomb\", \"attack\", \"beat\", \"fight\", \"hurt\", \"cut\", \"knife\",\n+    \"blood\", \"die\", \"death\", \"explode\", \"massacre\", \"slaughter\", \"terror\", \"terrorist\", \"suicide\",\n+    \"execute\", \"hang\", \"choke\", \"strangle\", \"torture\", \"assault\", \"gun\", \"weapon\", \"grenade\",\n+    \"blast\", \"war\", \"killself\", \"rape\", \"threat\", \"kill you\", \"beat you\", \"shoot you\", \"stab you\",\n+    \"die soon\", \"go die\", \"choke you\", \"slap you\", \"kick you\", \"murderer\", \"killer\", \"gang\",\n+    \"terrorattack\", \"lynch\", \"genocide\", \"brutality\", \"bloodbath\", \"executioner\", \"battlefield\"\n }\n+\n HATE_CONTEXT = {\n-    \"hate\", \"hateful\", \"disgusting\", \"disgrace\", \"scum\", \"trash\", \"vermin\", \"filth\",\n-    \"worthless\", \"dirty\", \"rotten\", \"evil\", \"ugly\", \"stupid\", \"idiot\", \"freak\", \"loser\",\n-    \"disgust\", \"vile\", \"toxic\", \"pig\", \"dog\", \"animal\", \"filthy\", \"garbage\", \"dumb\",\n-    \"moron\", \"monster\", \"trashbag\", \"sick\", \"degenerate\", \"disgusted\", \"nasty\", \"witch\",\n-    \"whore\", \"slut\", \"bastard\", \"cunt\", \"jerk\", \"retard\", \"psychopath\", \"coward\", \"clown\",\n-    \"racist\", \"racism\", \"nigger\", \"negro\", \"chink\", \"gook\", \"beaner\", \"cracker\",\n-    \"redneck\", \"wetback\", \"spic\", \"coon\", \"gypsy\", \"ape\", \"monkey\", \"tribal\",\n-    \"savage\", \"uncivilized\", \"subhuman\", \"slave\", \"jungleman\", \"go back to africa\",\n-    \"immigrant trash\", \"white trash\", \"brownie\", \"halfbreed\", \"yellowman\", \"arab terrorist\",\n-    \"terrorist\", \"sandnigger\", \"foreign scum\", \"blackie\", \"indiot\", \"hindu freak\",\n-    \"muslimterrorist\", \"muslimdog\", \"jewtrash\", \"antisemite\", \"kike\", \"christfreak\",\n-    \"jesusfreak\", \"allahlover\", \"pagan\", \"infidel\", \"devilworshipper\", \"heathen\",\n-    \"islamophobic\", \"islamophobia\", \"christophobia\", \"zionistpig\", \"holytrash\",\n-    \"churchburner\", \"quranburner\", \"templetrash\", \"buddhafreak\", \"atheistdog\",\n-    \"gay\", \"faggot\", \"lesbo\", \"dyke\", \"tranny\", \"transfreak\", \"queer\", \"homo\", \"gaytrash\",\n-    \"gendertrash\", \"crossdresser\", \"she-male\", \"ladyboy\", \"sissy\", \"feminazi\", \"misogynist\",\n-    \"bitch\", \"whore\", \"slut\", \"hoe\", \"gold-digger\", \"skank\", \"femalescum\", \"manhater\",\n-    \"toxicman\", \"gaylover\", \"rainbowtrash\", \"shemale\", \"queerfreak\", \"transhate\",\n-    \"paki\", \"chinesevirus\", \"indiantrash\", \"filipinotrash\", \"mexicantrash\", \"japtrash\",\n-    \"arabtrash\", \"blacktrash\", \"whitepig\", \"americandog\", \"chinklover\", \"asianpig\",\n-    \"europeanscum\", \"africantrash\", \"indiandog\", \"russianpig\", \"ukrainiantrash\",\n-    \"italianmafia\", \"irishdrunk\", \"africanmonkey\", \"browntrash\", \"latinopig\",\n-    \"nazi\", \"fascist\", \"commie\", \"communistpig\", \"lefttrash\", \"righttrash\", \"wokefreak\",\n-    \"snowflake\", \"libtard\", \"reptilian\", \"marxist\", \"extremist\", \"terrorlover\",\n-    \"redtrash\", \"bluepig\", \"demofreak\", \"repubfreak\", \"dictatorlover\",\n-    \"burnthem\", \"killthem\", \"destroythem\", \"shootthem\", \"wipeout\", \"exterminate\",\n-    \"hangthem\", \"dieall\", \"bombthem\", \"nuke\", \"eradicate\", \"masskill\", \"go back\",\n-    \"send them home\", \"get out\", \"not welcome\", \"you people\", \"your kind\", \"they all stink\",\n-    \"hate group\", \"whitepower\", \"blmtrash\", \"kkk\", \"neo-nazi\", \"skinhead\", \"supremacist\",\n-    \"gaschamber\", \"lynch\", \"execute\", \"no lives matter\", \"hatecrime\"\n+    \"hate\", \"disgusting\", \"scum\", \"trash\", \"vermin\", \"filth\", \"worthless\", \"ugly\", \"stupid\",\n+    \"idiot\", \"freak\", \"loser\", \"vile\", \"toxic\", \"pig\", \"dog\", \"animal\", \"garbage\", \"moron\",\n+    \"monster\", \"sick\", \"nasty\", \"witch\", \"whore\", \"slut\", \"bastard\", \"jerk\", \"coward\", \"clown\",\n+    \"racist\", \"nigger\", \"chink\", \"gook\", \"cracker\", \"spic\", \"coon\", \"slave\", \"immigrant trash\",\n+    \"terrorist\", \"sandnigger\", \"blacktrash\", \"whitepig\", \"americandog\", \"asianpig\", \"feminazi\",\n+    \"gay\", \"faggot\", \"lesbo\", \"dyke\", \"queer\", \"transhate\", \"paki\", \"nazi\", \"kkk\", \"skinhead\",\n+    \"supremacist\", \"lynch\", \"no lives matter\", \"hatecrime\"\n }\n+\n MENTAL_HEALTH_CONTEXT = {\n-    \"depressed\", \"sad\", \"hopeless\", \"worthless\", \"numb\", \"lonely\", \"miserable\", \"exhausted\",\n-    \"tiredoflife\", \"crying\", \"pain\", \"hurt\", \"useless\", \"empty\", \"lost\", \"dark\", \"lifeless\",\n-    \"can‚Äôt go on\", \"pointless\", \"suffering\", \"no one cares\", \"hate myself\", \"broken\", \"meaningless\",\n-    \"failed\", \"failure\", \"donewithlife\", \"lowenergy\", \"mentalpain\", \"despair\",\n-    \"anxiety\", \"panic\", \"scared\", \"fear\", \"overthinking\", \"nervous\", \"shaking\", \"paranoid\",\n-    \"can‚Äôt breathe\", \"panicattack\", \"heart racing\", \"stress\", \"worry\", \"suffocating\",\n-    \"fearful\", \"terrified\", \"no control\", \"helpless\", \"triggered\", \"anxious\", \"nervousbreakdown\",\n-    \"suicide\", \"kill myself\", \"end my life\", \"want to die\", \"cut myself\", \"selfharm\",\n-    \"slit my wrist\", \"i‚Äôm done\", \"die\", \"jump off\", \"no reason to live\", \"goodbye forever\",\n-    \"it‚Äôs over\", \"drinking bleach\", \"take pills\", \"not waking up\", \"hang myself\",\n-    \"bleed out\", \"can‚Äôt handle\", \"done living\", \"kill me\", \"suffocate\", \"overdose\",\n-    \"i‚Äôm tired of living\", \"i want to disappear\", \"self destruction\", \"goodbye world\",\n-    \"bullied\", \"they mock me\", \"i‚Äôm nothing\", \"they hate me\", \"everyone laughs\",\n-    \"embarrassed\", \"humiliated\", \"excluded\", \"unwanted\", \"rejected\", \"ignored\",\n-    \"no friends\", \"outcast\", \"they call me names\", \"i hate school\", \"hate everyone\",\n-    \"they make fun of me\", \"i‚Äôm ugly\", \"i‚Äôm stupid\", \"no one loves me\", \"can‚Äôt fit in\",\n-    \"trauma\", \"abuse\", \"molested\", \"raped\", \"beaten\", \"hurt inside\", \"broken soul\",\n-    \"can‚Äôt sleep\", \"nightmares\", \"flashbacks\", \"traumatized\", \"crisis\", \"abandoned\",\n-    \"controlled\", \"gaslight\", \"manipulated\", \"trapped\", \"fear of people\", \"haunted\",\n-    \"can‚Äôt trust anyone\", \"no escape\", \"mentalbreak\", \"suffering inside\",\n-    \"adhd\", \"bipolar\", \"schizophrenia\", \"psychosis\", \"ocd\", \"addiction\", \"autistic\",\n-    \"borderline\", \"personalitydisorder\", \"eatingdisorder\", \"anorexia\", \"bulimia\",\n-    \"alcoholic\", \"drugaddict\", \"mentallyill\", \"crazy\", \"insane\", \"psycho\", \"mad\", \"delusional\",\n-    \"you should die\", \"nobody cares\", \"kill yourself\", \"drink bleach\", \"you‚Äôre worthless\",\n-    \"no one loves you\", \"cut deeper\", \"just die\", \"go kill yourself\", \"hang yourself\",\n-    \"nobody would miss you\", \"do it already\", \"you‚Äôre a failure\", \"you‚Äôre disgusting\",\n-    \"why are you alive\", \"you‚Äôre a loser\", \"you deserve to die\", \"nobody likes you\",\n-    \"you should disappear\", \"your life is a joke\", \"kill yourself now\",\n-    \"need help\", \"talk to someone\", \"therapy\", \"mental health\", \"counseling\",\n-    \"helpline\", \"i want to talk\", \"need support\", \"i feel weak\", \"can‚Äôt do this\",\n-    \"i want to see a therapist\", \"help me\", \"i‚Äôm scared\", \"save me\", \"please listen\",\n-    \"nobody understands\", \"crisis hotline\", \"need someone to talk to\"\n+    \"depressed\", \"sad\", \"hopeless\", \"worthless\", \"numb\", \"lonely\", \"crying\", \"pain\", \"hurt\",\n+    \"useless\", \"empty\", \"lost\", \"dark\", \"suffering\", \"hate myself\", \"broken\", \"failed\", \"failure\",\n+    \"anxiety\", \"panic\", \"fear\", \"worry\", \"suicide\", \"kill myself\", \"end my life\", \"want to die\",\n+    \"selfharm\", \"slit my wrist\", \"die\", \"jump off\", \"no reason to live\", \"goodbye forever\",\n+    \"take pills\", \"hang myself\", \"bleed out\", \"kill me\", \"overdose\", \"i want to disappear\",\n+    \"bullied\", \"humiliated\", \"excluded\", \"no friends\", \"hate everyone\", \"i‚Äôm ugly\", \"trauma\",\n+    \"abuse\", \"molested\", \"raped\", \"broken soul\", \"can‚Äôt sleep\", \"fear of people\", \"helpless\",\n+    \"adhd\", \"bipolar\", \"schizophrenia\", \"ocd\", \"addiction\", \"anorexia\", \"alcoholic\",\n+    \"mentallyill\", \"crazy\", \"psycho\", \"kill yourself\", \"you‚Äôre worthless\", \"no one loves you\",\n+    \"cut deeper\", \"just die\", \"hang yourself\", \"you‚Äôre a loser\", \"you deserve to die\",\n+    \"help me\", \"therapy\", \"mental health\", \"helpline\", \"please listen\", \"need someone to talk\"\n }\n \n # ---------------------------------------------------\n # HELPERS\n@@ -228,24 +144,20 @@\n             data = []\n     data.append(entry)\n     log_path.write_text(json.dumps(data, indent=2))\n \n+\n # ---------------------------------------------------\n # DETECTION LOGIC\n # ---------------------------------------------------\n def predict_text(text: str, use_transformer: bool = False):\n-    \"\"\"\n-    Rule-based context ‚Üí Transformer (optional) ‚Üí Fallback TF-IDF\n-    \"\"\"\n     global transformer_pipeline\n     text_low = text.lower()\n     model_used = \"Fallback TF-IDF\"\n \n     def match_any(words):\n-        # substring match is intentional to catch plural / variants\n         return any(w in text_low for w in words)\n \n-    # 1) Rule-based immediate flags\n     if match_any(DIRTY_WORDS):\n         return \"Cyberbullying\", 0.99, \"Sexual/Obscene Language\"\n     if match_any(SEXUAL_CONTEXT):\n         return \"Cyberbullying\", 0.99, \"Sexual Harassment\"\n@@ -255,55 +167,50 @@\n         return \"Cyberbullying\", 0.96, \"Insult/Hate\"\n     if match_any(MENTAL_HEALTH_CONTEXT):\n         return \"Cyberbullying\", 0.94, \"Mental Health Abuse\"\n \n-    # 2) Transformer (if asked)\n     if use_transformer:\n         try:\n             from transformers import pipeline\n             model_name = str(LOCAL_TRANSFORMER_DIR) if LOCAL_TRANSFORMER_DIR.exists() else \"unitary/toxic-bert\"\n             if transformer_pipeline is None:\n-                print(f\"üîÑ Loading transformer model from: {model_name}\")\n                 transformer_pipeline = pipeline(\"text-classification\", model=model_name, device=-1)\n             pred = transformer_pipeline(text, truncation=True)[0]\n-            label = \"Cyberbullying\" if \"toxic\" in pred[\"label\"].lower() or pred[\"label\"].lower() in {\"label_1\", \"negative\"} else \"Non-Cyberbullying\"\n+            label = \"Cyberbullying\" if \"toxic\" in pred[\"label\"].lower() else \"Non-Cyberbullying\"\n             return label, float(pred.get(\"score\", 0.0)), f\"Transformer ({model_name})\"\n         except Exception as e:\n             print(\"Transformer error:\", e)\n \n-    # 3) Fallback TF-IDF\n     if FALLBACK is None:\n         return \"Error\", 0.0, \"No model\"\n     try:\n         pred = FALLBACK.predict([text])[0]\n         prob = float(FALLBACK.predict_proba([text])[0][1]) if hasattr(FALLBACK, \"predict_proba\") else 0.0\n         label = \"Cyberbullying\" if pred == 1 else \"Non-Cyberbullying\"\n         return label, prob, model_used\n     except Exception as e:\n-        print(f\"Fallback error: {e}\")\n         return \"Error\", 0.0, \"Fallback Error\"\n \n+\n # ---------------------------------------------------\n-# ROUTES: PAGES\n+# ROUTES\n # ---------------------------------------------------\n @app.get(\"/\", response_class=HTMLResponse)\n async def home(request: Request):\n     return templates.TemplateResponse(\"index.html\", {\"request\": request, \"result\": None})\n \n+\n @app.post(\"/predict\", response_class=HTMLResponse)\n async def predict(request: Request, text: str = Form(...), use_transformer: str = Form(\"no\")):\n     use_transformer = use_transformer.lower() in [\"yes\", \"on\", \"true\"]\n     label, prob, model_used = predict_text(text, use_transformer)\n     log_prediction_data(text, label)\n-    return templates.TemplateResponse(\n-        \"index.html\",\n-        {\"request\": request, \"result\": {\"text\": text, \"label\": label, \"prob\": prob, \"model\": model_used}},\n-    )\n+    return templates.TemplateResponse(\"index.html\", {\"request\": request, \"result\": {\"text\": text, \"label\": label, \"prob\": prob, \"model\": model_used}})\n \n+\n @app.get(\"/dashboard\", response_class=HTMLResponse)\n async def dashboard(request: Request):\n-    user = request.session.get(\"user\")\n-    if not user:\n+    if not request.session.get(\"user\"):\n         return RedirectResponse(\"/login\")\n     log_path = BASE_DIR / \"predictions_log.json\"\n     stats = {\"total\": 0, \"bullying\": 0, \"non\": 0, \"recent\": []}\n     if log_path.exists():\n@@ -311,29 +218,30 @@\n         stats[\"total\"] = len(data)\n         stats[\"recent\"] = data[-10:][::-1]\n         stats[\"bullying\"] = sum(1 for d in data if d[\"label\"] == \"Cyberbullying\")\n         stats[\"non\"] = stats[\"total\"] - stats[\"bullying\"]\n-    return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": user})\n+    return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": request.session.get(\"user\")})\n \n-# ---------------------------------------------------\n-# AUTH ROUTES (LOGIN / LOGOUT / REGISTER)\n-# ---------------------------------------------------\n+\n @app.get(\"/login\", response_class=HTMLResponse)\n async def login_page(request: Request):\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"\"})\n \n+\n @app.post(\"/login\", response_class=HTMLResponse)\n async def login_user(request: Request, username: str = Form(...), password: str = Form(...)):\n     users = get_users()\n     if username in users and users[username][\"password\"] == password:\n         request.session[\"user\"] = username\n         return RedirectResponse(\"/dashboard\", status_code=303)\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚ùå Invalid credentials\"})\n \n+\n @app.get(\"/register\", response_class=HTMLResponse)\n async def register_page(request: Request):\n     return templates.TemplateResponse(\"register.html\", {\"request\": request, \"message\": \"\"})\n \n+\n @app.post(\"/register\", response_class=HTMLResponse)\n async def register_user(request: Request, username: str = Form(...), password: str = Form(...)):\n     users = get_users()\n     if username in users:\n@@ -341,60 +249,67 @@\n     users[username] = {\"password\": password}\n     save_users(users)\n     return templates.TemplateResponse(\"login.html\", {\"request\": request, \"message\": \"‚úÖ Registered successfully! Please log in.\"})\n \n+\n @app.get(\"/logout\")\n async def logout(request: Request):\n     request.session.clear()\n     return RedirectResponse(\"/\", status_code=303)\n \n+\n # ---------------------------------------------------\n-# TRAINING ROUTES (kept)\n+# TRAINING ROUTES\n # ---------------------------------------------------\n-@app.get(\"/train_transformer\", response_class=HTMLResponse)\n-async def train_transformer_page(request: Request):\n-    # protect training behind login (optional)\n-    if not request.session.get(\"user\"):\n-        return RedirectResponse(\"/login\")\n-    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"user\": request.session.get(\"user\")})\n+@app.post(\"/upload_train\")\n+async def upload_and_train(file: UploadFile = File(...), background_tasks: BackgroundTasks = None):\n+    try:\n+        upload_path = BASE_DIR / \"uploads\"\n+        upload_path.mkdir(exist_ok=True)\n+        file_path = upload_path / file.filename\n+        with open(file_path, \"wb\") as f:\n+            f.write(await file.read())\n \n-@app.post(\"/train_transformer\", response_class=HTMLResponse)\n-async def train_transformer_post(\n-    request: Request,\n-    file: UploadFile = File(...),\n-    background_tasks: BackgroundTasks = None\n-):\n-    if not request.session.get(\"user\"):\n-        return RedirectResponse(\"/login\")\n-    content = await file.read()\n-    csv_path = BASE_DIR / f\"uploaded_{int(time.time())}.csv\"\n-    csv_path.write_bytes(content)\n+        log_path = BASE_DIR / \"train_status.log\"\n+        if log_path.exists():\n+            log_path.unlink()\n \n-    def run_training():\n-        status_log = BASE_DIR / \"train_status.log\"\n-        try:\n-            status_log.write_text(\"Training started...\\n\")\n-            model_path = train_transformer_model(str(csv_path))\n-            status_log.write_text(f\"‚úÖ Model trained successfully at: {model_path}\\n\")\n-        except Exception as e:\n-            status_log.write_text(f\"‚ùå Training failed: {e}\\n\")\n+        async def run_training():\n+            try:\n+                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n+                    log.write(f\"üöÄ Training started using {file.filename}\\n\")\n+                train_transformer_model(file_path)\n+                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n+                    log.write(\"‚úÖ Training completed successfully!\\n\")\n\\ No newline at end of file\n+            except Exception as e:\n+                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n+                    log.write(f\"‚ùå Training failed: {e}\\n\")\n \n-    background_tasks.add_task(run_training)\n-    message = \"üöÄ Training started. Check this page in a bit to see the status.\"\n-    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": message, \"user\": request.session.get(\"user\")})\n+        if background_tasks:\n+            background_tasks.add_task(run_training)\n+        else:\n+            asyncio.create_task(run_training())\n \n+        return {\"status\": \"success\", \"message\": \"Training started!\"}\n+    except Exception as e:\n+        return {\"status\": \"error\", \"message\": str(e)}\n+\n+\n @app.get(\"/train_logs\")\n async def stream_training_logs():\n     log_path = BASE_DIR / \"train_status.log\"\n-    def log_stream():\n-        try:\n-            with open(log_path, \"r\", encoding=\"utf-8\") as file:\n-                # Continuously yield new lines\n-                while True:\n-                    line = file.readline()\n-                    if line:\n-                        yield line\n-                    else:\n-                        time.sleep(0.5)\n-        except Exception as e:\n-            yield f\"Error reading log: {str(e)}\"\n-    return StreamingResponse(log_stream(), media_type=\"text/plain\")\n+\n+    async def log_stream():\n+        last_size = 0\n+        while True:\n+            await asyncio.sleep(1)\n+            if log_path.exists():\n+                new_size = log_path.stat().st_size\n+                if new_size > last_size:\n+                    with open(log_path, \"r\", encoding=\"utf-8\") as f:\n+                        f.seek(last_size)\n+                        chunk = f.read()\n+                        last_size = new_size\n+                        if chunk:\n+                            yield f\"data: {chunk}\\n\\n\"\n+\n+    return StreamingResponse(log_stream(), media_type=\"text/event-stream\")\n"
                },
                {
                    "date": 1762604367348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -255,9 +255,14 @@\n async def logout(request: Request):\n     request.session.clear()\n     return RedirectResponse(\"/\", status_code=303)\n \n-\n+@app.get(\"/train_transformer\", response_class=HTMLResponse)\n+async def train_transformer_page(request: Request):\n+    \"\"\"Render the transformer training upload page\"\"\"\n+    if not request.session.get(\"user\"):\n+        return RedirectResponse(\"/login\")\n+    return templates.TemplateResponse(\"train_transformer.html\", {\"request\": request})\n # ---------------------------------------------------\n # TRAINING ROUTES\n # ---------------------------------------------------\n @app.post(\"/upload_train\")\n@@ -311,5 +316,5 @@\n                         last_size = new_size\n                         if chunk:\n                             yield f\"data: {chunk}\\n\\n\"\n \n-    return StreamingResponse(log_stream(), media_type=\"text/event-stream\")\n\\ No newline at end of file\n+    return StreamingResponse(log_stream(), media_type=\"text/event-stream\")\n"
                },
                {
                    "date": 1762605849419,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -257,64 +257,58 @@\n     return RedirectResponse(\"/\", status_code=303)\n \n @app.get(\"/train_transformer\", response_class=HTMLResponse)\n async def train_transformer_page(request: Request):\n-    \"\"\"Render the transformer training upload page\"\"\"\n+    \"\"\"Page to upload dataset and start Transformer training\"\"\"\n     if not request.session.get(\"user\"):\n         return RedirectResponse(\"/login\")\n-    return templates.TemplateResponse(\"train_transformer.html\", {\"request\": request})\n-# ---------------------------------------------------\n-# TRAINING ROUTES\n-# ---------------------------------------------------\n+    return templates.TemplateResponse(\"train_transformer.html\", {\"request\": request, \"user\": request.session.get(\"user\")})\n+\n+\n @app.post(\"/upload_train\")\n-async def upload_and_train(file: UploadFile = File(...), background_tasks: BackgroundTasks = None):\n-    try:\n-        upload_path = BASE_DIR / \"uploads\"\n-        upload_path.mkdir(exist_ok=True)\n-        file_path = upload_path / file.filename\n-        with open(file_path, \"wb\") as f:\n-            f.write(await file.read())\n+async def upload_and_train(request: Request, file: UploadFile = File(...)):\n+    \"\"\"Handle dataset upload and trigger background training\"\"\"\n+    if not request.session.get(\"user\"):\n+        return JSONResponse({\"error\": \"Unauthorized\"}, status_code=401)\n \n-        log_path = BASE_DIR / \"train_status.log\"\n-        if log_path.exists():\n-            log_path.unlink()\n+    TRAINING_LOG_FILE.write_text(\"üöÄ Training started...\\n\")\n \n-        async def run_training():\n-            try:\n-                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n-                    log.write(f\"üöÄ Training started using {file.filename}\\n\")\n-                train_transformer_model(file_path)\n-                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n-                    log.write(\"‚úÖ Training completed successfully!\\n\")\n-            except Exception as e:\n-                with open(log_path, \"a\", encoding=\"utf-8\") as log:\n-                    log.write(f\"‚ùå Training failed: {e}\\n\")\n+    # Save uploaded CSV\n+    filename = f\"uploaded_{int(time.time())}.csv\"\n+    csv_path = BASE_DIR / \"uploads\" / filename\n+    csv_path.write_bytes(await file.read())\n \n-        if background_tasks:\n-            background_tasks.add_task(run_training)\n-        else:\n-            asyncio.create_task(run_training())\n+    def background_training():\n+        try:\n+            with open(TRAINING_LOG_FILE, \"a\", encoding=\"utf-8\") as logf:\n+                logf.write(f\"üìÇ Loading dataset: {csv_path}\\n\")\n+            train_transformer_model(str(csv_path))\n+            with open(TRAINING_LOG_FILE, \"a\", encoding=\"utf-8\") as logf:\n+                logf.write(\"\\n‚úÖ Training completed successfully!\\n\")\n+        except Exception as e:\n+            with open(TRAINING_LOG_FILE, \"a\", encoding=\"utf-8\") as logf:\n+                logf.write(f\"\\n‚ùå Training failed: {e}\\n\")\n \n-        return {\"status\": \"success\", \"message\": \"Training started!\"}\n-    except Exception as e:\n-        return {\"status\": \"error\", \"message\": str(e)}\n+    thread = threading.Thread(target=background_training)\n+    thread.start()\n \n+    return JSONResponse({\"message\": f\"Training started using {file.filename}\"})\n \n+\n @app.get(\"/train_logs\")\n-async def stream_training_logs():\n-    log_path = BASE_DIR / \"train_status.log\"\n-\n-    async def log_stream():\n-        last_size = 0\n+async def train_logs():\n+    \"\"\"Stream training logs live to the browser\"\"\"\n+    def stream():\n+        last_pos = 0\n         while True:\n-            await asyncio.sleep(1)\n-            if log_path.exists():\n-                new_size = log_path.stat().st_size\n-                if new_size > last_size:\n-                    with open(log_path, \"r\", encoding=\"utf-8\") as f:\n-                        f.seek(last_size)\n-                        chunk = f.read()\n-                        last_size = new_size\n-                        if chunk:\n-                            yield f\"data: {chunk}\\n\\n\"\n-\n-    return StreamingResponse(log_stream(), media_type=\"text/event-stream\")\n+            try:\n+                if TRAINING_LOG_FILE.exists():\n+                    with open(TRAINING_LOG_FILE, \"r\", encoding=\"utf-8\") as f:\n+                        f.seek(last_pos)\n+                        lines = f.readlines()\n+                        last_pos = f.tell()\n+                        for line in lines:\n+                            yield f\"data: {line.strip()}\\n\\n\"\n+                time.sleep(1)\n+            except Exception as e:\n+                yield f\"data: [Stream Error] {e}\\n\\n\"\n+    return StreamingResponse(stream(), media_type=\"text/event-stream\")\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762605866887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n+TRAINING_LOG_FILE = BASE_DIR / \"train_status.log\"\n \n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n"
                },
                {
                    "date": 1762606019464,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n-TRAINING_LOG_FILE = BASE_DIR / \"train_status.log\"\n+TRAINING_LOG_FILE.write_text(\"üöÄ Training started...\\n\", encoding=\"utf-8\")\n \n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n"
                },
                {
                    "date": 1762606093047,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,12 +6,14 @@\n import joblib, os, json, time, asyncio\n from pathlib import Path\n from datetime import datetime\n from train_transformer import train_transformer_model\n+import sys\n \n # ---------------------------------------------------\n # APP INITIALIZATION\n # ---------------------------------------------------\n+sys.stdout.reconfigure(encoding='utf-8')\n app = FastAPI(title=\"Cyberbullying Detection System\")\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n"
                },
                {
                    "date": 1762606215494,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,9 +17,8 @@\n BASE_DIR = Path(__file__).resolve().parent\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n-TRAINING_LOG_FILE.write_text(\"üöÄ Training started...\\n\", encoding=\"utf-8\")\n \n # ---------------------------------------------------\n # MODEL LOADING\n # ---------------------------------------------------\n@@ -272,9 +271,9 @@\n     \"\"\"Handle dataset upload and trigger background training\"\"\"\n     if not request.session.get(\"user\"):\n         return JSONResponse({\"error\": \"Unauthorized\"}, status_code=401)\n \n-    TRAINING_LOG_FILE.write_text(\"üöÄ Training started...\\n\")\n+    TRAINING_LOG_FILE.write_text(\"üöÄ Training started...\\n\", encoding=\"utf-8\")\n \n     # Save uploaded CSV\n     filename = f\"uploaded_{int(time.time())}.csv\"\n     csv_path = BASE_DIR / \"uploads\" / filename\n"
                },
                {
                    "date": 1762606265906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,9 @@\n # ---------------------------------------------------\n sys.stdout.reconfigure(encoding='utf-8')\n app = FastAPI(title=\"Cyberbullying Detection System\")\n BASE_DIR = Path(__file__).resolve().parent\n+TRAINING_LOG_FILE = BASE_DIR / \"train_status.log\"\n templates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\n app.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n app.add_middleware(SessionMiddleware, secret_key=\"supersecret123\")\n \n"
                },
                {
                    "date": 1762606420843,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n from fastapi.responses import HTMLResponse, RedirectResponse, StreamingResponse\n from fastapi.staticfiles import StaticFiles\n from fastapi.templating import Jinja2Templates\n from starlette.middleware.sessions import SessionMiddleware\n-import joblib, os, json, time, asyncio\n+import joblib, os, json, time, asyncio, threading\n from pathlib import Path\n from datetime import datetime\n from train_transformer import train_transformer_model\n import sys\n"
                },
                {
                    "date": 1762606851202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n from pathlib import Path\n from datetime import datetime\n from train_transformer import train_transformer_model\n import sys\n+import asyncio\n \n # ---------------------------------------------------\n # APP INITIALIZATION\n # ---------------------------------------------------\n@@ -298,20 +299,19 @@\n \n \n @app.get(\"/train_logs\")\n async def train_logs():\n-    \"\"\"Stream training logs live to the browser\"\"\"\n-    def stream():\n-        last_pos = 0\n+    \"\"\"Stream real-time training logs to the frontend.\"\"\"\n+    LOG_FILE = BASE_DIR / \"train_status.log\"\n+\n+    async def event_stream():\n+        last_size = 0\n         while True:\n-            try:\n-                if TRAINING_LOG_FILE.exists():\n-                    with open(TRAINING_LOG_FILE, \"r\", encoding=\"utf-8\") as f:\n-                        f.seek(last_pos)\n-                        lines = f.readlines()\n-                        last_pos = f.tell()\n-                        for line in lines:\n\\ No newline at end of file\n-                            yield f\"data: {line.strip()}\\n\\n\"\n-                time.sleep(1)\n-            except Exception as e:\n-                yield f\"data: [Stream Error] {e}\\n\\n\"\n-    return StreamingResponse(stream(), media_type=\"text/event-stream\")\n+            await asyncio.sleep(1)\n+            if LOG_FILE.exists():\n+                data = LOG_FILE.read_text(encoding=\"utf-8\")\n+                if len(data) > last_size:\n+                    chunk = data[last_size:]\n+                    last_size = len(data)\n+                    yield f\"data: {chunk}\\n\\n\"\n+\n+    return StreamingResponse(event_stream(), media_type=\"text/event-stream\")\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762607101069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n from fastapi import FastAPI, Request, Form, UploadFile, File, HTTPException, BackgroundTasks\n-from fastapi.responses import HTMLResponse, RedirectResponse, StreamingResponse\n+from fastapi.responses import HTMLResponse, RedirectResponse, StreamingResponse, JSONResponse\n from fastapi.staticfiles import StaticFiles\n from fastapi.templating import Jinja2Templates\n from starlette.middleware.sessions import SessionMiddleware\n import joblib, os, json, time, asyncio, threading\n"
                }
            ],
            "date": 1762599790171,
            "name": "Commit-0",
            "content": "from fastapi import FastAPI, Request, Form, UploadFile, File, Depends, HTTPException, BackgroundTasks\nfrom fastapi.responses import HTMLResponse, JSONResponse\nfrom fastapi.staticfiles import StaticFiles\nfrom fastapi.templating import Jinja2Templates\nfrom fastapi.security import HTTPBasic, HTTPBasicCredentials\nimport joblib, os, json, time\nfrom pathlib import Path\nfrom datetime import datetime\nfrom train_transformer import train_transformer_model\n\n# ---------------------------------------------------\n# APP INITIALIZATION\n# ---------------------------------------------------\napp = FastAPI(title=\"Cyberbullying Detection System\")\nBASE_DIR = Path(__file__).resolve().parent\ntemplates = Jinja2Templates(directory=str(BASE_DIR / \"templates\"))\napp.mount(\"/static\", StaticFiles(directory=str(BASE_DIR / \"static\")), name=\"static\")\n\nsecurity = HTTPBasic()\n\n\n# ---------------------------------------------------\n# MODEL LOADING\n# ---------------------------------------------------\ntry:\n    FALLBACK = joblib.load(BASE_DIR / \"model.pkl\")\n    print(\"‚úÖ Loaded fallback model (model.pkl).\")\nexcept Exception as e:\n    print(f\"‚ö†Ô∏è Fallback model not found: {e}\")\n    FALLBACK = None\n\ntransformer_pipeline = None\n\n\n# ---------------------------------------------------\n# CYBERBULLYING WORD CONTEXT LISTS\n# ---------------------------------------------------\nSEXUAL_CONTEXT = {\n    \"sexy\", \"hot\", \"naughty\", \"babe\", \"send pic\", \"kiss\", \"boobs\", \"nude\",\n    \"handsome\", \"beautiful\", \"pretty\", \"cute girl\", \"bed\", \"flirt\", \"babe\",\n    \"date me\", \"love u\", \"strip\", \"naughty girl\", \"body\", \"lust\", \"porn\"\n}\n\nVIOLENCE_CONTEXT = {\n    \"kill\", \"bomb\", \"murder\", \"attack\", \"shoot\", \"gun\", \"destroy\", \"stab\",\n    \"die\", \"death\", \"blood\", \"terror\", \"explode\", \"threat\"\n}\n\nHATE_CONTEXT = {\n    \"hate\", \"idiot\", \"stupid\", \"dumb\", \"moron\", \"worthless\", \"fat\", \"ugly\",\n    \"trash\", \"loser\", \"jerk\", \"freak\", \"bitch\", \"bastard\", \"slut\", \"pig\"\n}\n\nRELIGIOUS_CONTEXT = {\n    \"islam\", \"christian\", \"hindu\", \"jew\", \"allah\", \"jesus\", \"temple\", \"church\",\n    \"religion\", \"quran\", \"bible\", \"prophet\", \"god\", \"priest\", \"muslim\", \"satan\"\n}\n\nMENTAL_HEALTH_CONTEXT = {\n    \"suicide\", \"depress\", \"kill yourself\", \"go die\", \"hopeless\", \"worthless\",\n    \"sad\", \"hurt\", \"anxiety\", \"alone\", \"mental\", \"die now\"\n}\n\n# ---------------------------------------------------\n# UTILITY FUNCTIONS\n# ---------------------------------------------------\ndef datetimeformat(value):\n    try:\n        return datetime.fromtimestamp(value).strftime(\"%Y-%m-%d %H:%M:%S\")\n    except Exception:\n        return \"N/A\"\n\ntemplates.env.filters[\"datetimeformat\"] = datetimeformat\n\n\n# ---------------------------------------------------\n# AUTHENTICATION\n# ---------------------------------------------------\ndef get_current_username(credentials: HTTPBasicCredentials = Depends(security)):\n    correct_username = os.environ.get(\"DEMO_USER\", \"admin\")\n    correct_password = os.environ.get(\"DEMO_PASS\", \"password\")\n    if credentials.username == correct_username and credentials.password == correct_password:\n        return credentials.username\n    raise HTTPException(status_code=401, detail=\"Unauthorized\")\n\n\n# ---------------------------------------------------\n# MAIN DETECTION FUNCTION\n# ---------------------------------------------------\ndef predict_text(text: str, use_transformer: bool = False):\n    \"\"\"Detect cyberbullying content using rules + transformer + fallback model.\"\"\"\n    global transformer_pipeline\n    model_used = \"Fallback TF-IDF\"\n    lower_text = text.lower().strip()\n\n    def match_any(phrases):\n        return any(phrase in lower_text for phrase in phrases)\n\n    # --- Enhanced Rule-based Filters ---\n    if match_any(SEXUAL_CONTEXT):\n        return \"Cyberbullying\", 0.99, \"Sexual/Harassment Content\"\n    if match_any(VIOLENCE_CONTEXT):\n        return \"Cyberbullying\", 0.98, \"Violent/Threatening Language\"\n    if match_any(HATE_CONTEXT):\n        return \"Cyberbullying\", 0.97, \"Hate/Insult Language\"\n    if match_any(RELIGIOUS_CONTEXT):\n        return \"Cyberbullying\", 0.96, \"Religious Disrespect\"\n    if match_any(MENTAL_HEALTH_CONTEXT):\n        return \"Cyberbullying\", 0.95, \"Mental Health Abuse\"\n\n    # Context-based short phrases\n    if any(word in lower_text for word in [\"send pic\", \"naughty\", \"flirt\", \"babe\", \"hot girl\", \"hi sexy\", \"cute body\"]):\n        return \"Cyberbullying\", 0.97, \"Flirty/Harassment Message\"\n    if any(word in lower_text for word in [\"go die\", \"hate you\", \"you are ugly\", \"fool\", \"idiot\", \"fat\", \"loser\"]):\n        return \"Cyberbullying\", 0.96, \"Insult/Abuse Message\"\n\n    # --- Transformer model ---\n    if use_transformer:\n        model_name = os.environ.get(\"HF_MODEL\", \"unitary/toxic-bert\")\n        try:\n            from transformers import pipeline\n            if transformer_pipeline is None:\n                print(f\"üîÑ Loading transformer model: {model_name}\")\n                transformer_pipeline = pipeline(\"text-classification\", model=model_name, device=-1)\n\n            pred = transformer_pipeline(text, truncation=True)[0]\n            label_raw = pred.get(\"label\", \"\").lower()\n            score = float(pred.get(\"score\", 0.0))\n            toxic_keywords = [\"toxic\", \"abuse\", \"offensive\", \"hate\", \"insult\"]\n\n            if any(k in label_raw for k in toxic_keywords) or \"label_1\" in label_raw:\n                label = \"Cyberbullying\" if score >= 0.45 else \"Non-Cyberbullying\"\n            else:\n                label = \"Cyberbullying\" if score >= 0.75 and label_raw.startswith(\"negative\") else \"Non-Cyberbullying\"\n\n            return label, score, f\"Transformer ({model_name})\"\n        except Exception as e:\n            print(f\"‚ö†Ô∏è Transformer Error: {e}\")\n            return \"Error\", 0.0, f\"Transformer ({model_name})\"\n\n    # --- Fallback Model (TF-IDF) ---\n    if FALLBACK is not None:\n        try:\n            pred = FALLBACK.predict([text])[0]\n            prob = float(FALLBACK.predict_proba([text])[0][1]) if hasattr(FALLBACK, \"predict_proba\") else 0.5\n            label = \"Cyberbullying\" if pred == 1 else \"Non-Cyberbullying\"\n            return label, prob, model_used\n        except Exception as e:\n            print(f\"‚ö†Ô∏è Fallback model error: {e}\")\n            return \"Error\", 0.0, \"Fallback Error\"\n\n    return \"Error\", 0.0, \"No model available\"\n\n\n# ---------------------------------------------------\n# LOGGING\n# ---------------------------------------------------\ndef log_prediction_data(text, label):\n    log_path = BASE_DIR / \"predictions_log.json\"\n    entry = {\"text\": text, \"label\": label, \"timestamp\": time.time()}\n    data = []\n    if log_path.exists():\n        try:\n            data = json.loads(log_path.read_text())\n        except Exception:\n            data = []\n    data.append(entry)\n    log_path.write_text(json.dumps(data, indent=2))\n\n\n# ---------------------------------------------------\n# ROUTES\n# ---------------------------------------------------\n@app.get(\"/\", response_class=HTMLResponse)\nasync def home(request: Request):\n    return templates.TemplateResponse(\"index.html\", {\"request\": request, \"result\": None})\n\n\n@app.post(\"/predict\", response_class=HTMLResponse)\nasync def predict(request: Request, text: str = Form(...), use_transformer: str = Form(\"no\")):\n    use_transformer = use_transformer.lower() in [\"yes\", \"on\", \"true\"]\n    label, prob, model_used = predict_text(text, use_transformer)\n    log_prediction_data(text, label)\n    return templates.TemplateResponse(\n        \"index.html\",\n        {\"request\": request, \"result\": {\"text\": text, \"label\": label, \"prob\": prob, \"model\": model_used}},\n    )\n\n\n@app.get(\"/dashboard\", response_class=HTMLResponse)\nasync def dashboard(request: Request, username: str = Depends(get_current_username)):\n    \"\"\"Admin dashboard view\"\"\"\n    log_path = BASE_DIR / \"predictions_log.json\"\n    stats = {\"total\": 0, \"bullying\": 0, \"non\": 0, \"recent\": []}\n    if log_path.exists():\n        data = json.loads(log_path.read_text())\n        stats[\"total\"] = len(data)\n        stats[\"recent\"] = data[-10:][::-1]\n        stats[\"bullying\"] = sum(1 for d in data if d[\"label\"] == \"Cyberbullying\")\n        stats[\"non\"] = stats[\"total\"] - stats[\"bullying\"]\n    return templates.TemplateResponse(\"dashboard.html\", {\"request\": request, \"stats\": stats, \"user\": username})\n\n\n@app.get(\"/train_transformer\", response_class=HTMLResponse)\nasync def train_transformer_page(request: Request, username: str = Depends(get_current_username)):\n    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"user\": username})\n\n\n@app.post(\"/train_transformer\", response_class=HTMLResponse)\nasync def train_transformer_post(\n    request: Request,\n    file: UploadFile = File(...),\n    background_tasks: BackgroundTasks = None,\n    username: str = Depends(get_current_username)\n):\n    \"\"\"Train transformer using uploaded CSV\"\"\"\n    content = await file.read()\n    models_dir = BASE_DIR / \"models\"\n    models_dir.mkdir(exist_ok=True)\n    csv_path = models_dir / f\"uploaded_{int(time.time())}.csv\"\n    csv_path.write_bytes(content)\n\n    def run_training():\n        try:\n            model_path = train_transformer_model(str(csv_path))\n            with open(BASE_DIR / \"train_status.log\", \"w\", encoding=\"utf-8\") as f:\n                f.write(f\"‚úÖ Model trained successfully at {model_path}\\n\")\n        except Exception as e:\n            with open(BASE_DIR / \"train_status.log\", \"w\", encoding=\"utf-8\") as f:\n                f.write(f\"‚ùå Training failed: {e}\\n\")\n\n    background_tasks.add_task(run_training)\n    message = \"üöÄ Training started in background. Please wait and refresh.\"\n    return templates.TemplateResponse(\"train_notice.html\", {\"request\": request, \"message\": message, \"user\": username})\n"
        }
    ]
}